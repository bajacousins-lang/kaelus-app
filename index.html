<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>BCNTV Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --accent: #00ff88; --bg: #000; --card: #121212; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; padding: 15px; margin: 0; }
        .search-box { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #1a1a1a; color: #fff; margin-bottom: 15px; box-sizing: border-box; outline: none; }
        .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; position: sticky; top: 0; background: var(--bg); z-index: 10; }
        .pill { background: #222; border: 1px solid #333; color: #888; padding: 8px 16px; border-radius: 20px; white-space: nowrap; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .pill.active { background: var(--accent); color: #000; border-color: var(--accent); }
        .card { background: var(--card); border-radius: 12px; padding: 12px; border: 1px solid #222; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; }
        .logo-container { width: 55px; height: 75px; flex-shrink: 0; border-radius: 8px; border: 1px solid #333; overflow: hidden; }
        .logo-img { width: 100%; height: 100%; object-fit: cover; }
        .info { flex-grow: 1; min-width: 0; }
        .cat-tag { font-size: 9px; color: var(--accent); font-weight: bold; text-transform: uppercase; }
        .title { font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #eee; }
        .actions { display: flex; align-items: center; gap: 10px; }
        .btn-play { background: var(--accent); color: #000; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-fav { background: none; border: none; font-size: 20px; cursor: pointer; color: #444; }
        .btn-fav.active { color: #ffeb3b; }
        #loader { text-align: center; margin-top: 35vh; color: var(--accent); font-weight: bold; }
        #status { margin: 10px 0 15px; color: #ffc107; font-size: 12px; display: none; align-items: center; gap: 8px; }
        #status[data-level="2"] { color: #ff9800; }
        #status[data-level="3"] { color: #ff5252; }
        #status-message { flex: 1; }
        #status-close { background: none; border: none; color: #ffc107; font-size: 14px; cursor: pointer; }

        /* MODAL */
        #infoModal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.75); z-index:9999; padding:18px; box-sizing:border-box; }
        #infoModalPanel { max-width:520px; margin:12vh auto 0; background:#121212; border:1px solid #222; border-radius:16px; padding:14px; }
        #modalTop { display:flex; align-items:flex-start; gap:12px; }
        #modalImgWrap { width:72px; height:96px; border-radius:10px; overflow:hidden; border:1px solid #333; flex-shrink:0; }
        #modalImg { width:100%; height:100%; object-fit:cover; }
        #modalCat { font-size:10px; color:var(--accent); font-weight:800; text-transform:uppercase; }
        #modalTitle { margin-top:6px; font-size:16px; font-weight:800; color:#eee; line-height:1.25; word-break:break-word; }
        #modalNote { margin-top:10px; font-size:12px; color:#aaa; }
        #modalCloseBtn { background:none; border:none; color:#bbb; font-size:18px; cursor:pointer; line-height:1; }
        #modalActions { display:flex; gap:10px; margin-top:14px; justify-content:flex-end; }
        #modalCopyBtn { background:#222; border:1px solid #333; color:#ddd; padding:10px 12px; border-radius:10px; font-weight:700; cursor:pointer; }
        #modalOkBtn { background:var(--accent); border:none; color:#000; padding:10px 14px; border-radius:10px; font-weight:900; cursor:pointer; }
    </style>
</head>
<body>
    <input type="text" id="search" class="search-box" placeholder="üîç Buscar en BCNTV...">
    <div class="filter-bar" id="filter-bar"></div>
    <div id="status">
        <span id="status-message"></span>
        <button id="status-close" type="button" aria-label="Cerrar aviso">‚úï</button>
    </div>
    <div id="loader">üõ∞Ô∏è Conectando con Servidor...</div>
    <div id="container"></div>

    <!-- MODAL INFO -->
    <div id="infoModal" aria-hidden="true">
        <div id="infoModalPanel" role="dialog" aria-modal="true">
            <div id="modalTop">
                <div id="modalImgWrap">
                    <img id="modalImg" src="logo.png" onerror="this.src='logo.png'">
                </div>
                <div style="flex:1; min-width:0;">
                    <div id="modalCat"></div>
                    <div id="modalTitle"></div>
                    <div id="modalNote">‚ÑπÔ∏è Informaci√≥n mostrada dentro de la app.</div>
                </div>
                <button id="modalCloseBtn" type="button" aria-label="Cerrar">‚úï</button>
            </div>
            <div id="modalActions">
                <button id="modalCopyBtn" type="button">Copiar</button>
                <button id="modalOkBtn" type="button">OK</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram?.WebApp;
        const API_URL = window.API_URL || "https://kaelus-bot.onrender.com";

        let allItems = [];
        let currentFilter = 'TODOS';
        let currentSearch = '';
        let retryCount = 0;
        const maxRetries = 5;
        const baseRetryDelay = 2000;
        const fetchTimeoutMs = 10000;
        let initInProgress = false;

        let lastDropCount = 0;
        let lastDropMessage = '';
        let lastDropShown = false;

        let currentStatusMessage = '';
        let currentStatusLevel = 0;
        const loaderDefaultText = 'üõ∞Ô∏è Conectando con Servidor...';

        // Mapa r√°pido: u -> item (para abrir modal sin buscar)
        const itemsByUrl = new Map();

        const categoryAliases = {
            '‚öΩ DEPORTES': '‚öΩ DEPORTES',
            'DEPORTES': '‚öΩ DEPORTES',
            'üé¨ CINE': 'üé¨ CINE',
            'CINE': 'üé¨ CINE',
            'üì∫ SERIES': 'üì∫ SERIES',
            'SERIES': 'üì∫ SERIES',
        };

        function showError(message) {
            const loader = document.getElementById('loader');
            loader.textContent = message;
            loader.style.display = 'block';
            if (!allItems.length) {
                document.getElementById('container').innerHTML = '';
            }
            clearStatus();
        }

        function showStatus(message, level = 1, force = false) {
            const status = document.getElementById('status');
            const messageEl = document.getElementById('status-message');
            if (!message) {
                clearStatus();
                return;
            }
            if (!force && currentStatusMessage && level < currentStatusLevel) {
                return;
            }
            messageEl.textContent = message;
            status.style.display = 'flex';
            status.dataset.level = String(level);
            currentStatusMessage = message;
            currentStatusLevel = level;
        }

        function clearStatus() {
            const status = document.getElementById('status');
            const messageEl = document.getElementById('status-message');
            messageEl.textContent = '';
            status.style.display = 'none';
            delete status.dataset.level;
            currentStatusMessage = '';
            currentStatusLevel = 0;
        }

        function sanitizeUrl(url) {
            if (!url) return null;
            try {
                const parsed = new URL(String(url), window.location.href);
                if (parsed.protocol === 'http:' || parsed.protocol === 'https:') {
                    return parsed.href;
                }
            } catch (e) {
                return null;
            }
            return null;
        }

        function sanitizeLinkUrl(url) {
            return sanitizeUrl(url);
        }

        function normalizeCategory(cat) {
            if (!cat) return 'SIN CATEGOR√çA';
            const raw = String(cat).trim();
            return categoryAliases[raw.toUpperCase()] || raw;
        }

        function normalizeItems(data) {
            if (!Array.isArray(data)) return null;

            let droppedInvalidUrl = 0;
            let droppedMissingFields = 0;

            const items = data
                .filter(item => {
                    if (!item || !item.u || !item.t) {
                        droppedMissingFields += 1;
                        return false;
                    }
                    return true;
                })
                .map(item => {
                    const link = sanitizeLinkUrl(item.u);
                    if (!link) {
                        droppedInvalidUrl += 1;
                        return null;
                    }
                    return {
                        u: link,
                        t: String(item.t),
                        cat: normalizeCategory(item.cat),
                        img: sanitizeUrl(item.img) || 'logo.png',
                    };
                })
                .filter(Boolean);

            lastDropCount = droppedInvalidUrl + droppedMissingFields;
            lastDropMessage = '';
            lastDropShown = false;

            if (lastDropCount) {
                const parts = [];
                if (droppedInvalidUrl) parts.push(`${droppedInvalidUrl} por URL inv√°lida`);
                if (droppedMissingFields) parts.push(`${droppedMissingFields} por datos incompletos`);
                lastDropMessage = `‚ö†Ô∏è ${parts.join(' y ')}.`;
            }
            return items;
        }

        function escapeHtml(value) {
            return String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // MODAL
        function openInfoModal(item) {
            if (!item) return;
            document.getElementById('modalTitle').textContent = item.t || '';
            document.getElementById('modalCat').textContent = item.cat || '';
            const imgEl = document.getElementById('modalImg');
            imgEl.src = item.img || 'logo.png';

            const modal = document.getElementById('infoModal');
            modal.style.display = 'block';
            modal.setAttribute('aria-hidden', 'false');
            tg?.HapticFeedback?.impactOccurred?.('light');
        }

        function closeInfoModal() {
            const modal = document.getElementById('infoModal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
        }

        async function copyModalText() {
            const title = document.getElementById('modalTitle').textContent || '';
            const cat = document.getElementById('modalCat').textContent || '';
            const text = `${cat}\n${title}`.trim();
            try {
                await navigator.clipboard.writeText(text);
                showStatus('‚úÖ Copiado al portapapeles', 1, true);
            } catch (e) {
                try {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    document.body.appendChild(ta);
                    ta.select();
                    document.execCommand('copy');
                    document.body.removeChild(ta);
                    showStatus('‚úÖ Copiado al portapapeles', 1, true);
                } catch {
                    showStatus('‚ö†Ô∏è No se pudo copiar', 2, true);
                }
            }
        }

        // ‚úÖ Mantengo tu bot√≥n VER y tu render, pero ahora VER abre modal
        function safeOpenLink(url) {
            const safeUrl = sanitizeLinkUrl(url);
            if (!safeUrl) {
                showStatus('‚ö†Ô∏è Enlace inv√°lido. Actualiza la lista e intenta de nuevo.', 1);
                return;
            }
            const item = itemsByUrl.get(safeUrl);
            if (!item) {
                showStatus('‚ö†Ô∏è No se encontr√≥ informaci√≥n del elemento. Actualiza la lista.', 2, true);
                return;
            }
            openInfoModal(item);
        }

        function safeGetFavs() {
            try {
                const parsed = JSON.parse(localStorage.getItem('bcntv_favs') || '[]');
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }

        function safeSetFavs(favs) {
            try {
                localStorage.setItem('bcntv_favs', JSON.stringify(favs));
            } catch (e) {}
        }

        async function init() {
            if (initInProgress) return;
            initInProgress = true;

            lastDropCount = 0;
            lastDropMessage = '';
            lastDropShown = false;

            let timeoutId = null;
            try {
                const controller = new AbortController();
                timeoutId = setTimeout(() => controller.abort(), fetchTimeoutMs);

                const res = await fetch(`${API_URL}/api/links`, { signal: controller.signal });
                if (!res.ok) {
                    throw new Error(`Error ${res.status}`);
                }

                const data = await res.json();
                const normalized = normalizeItems(data);
                if (normalized === null) {
                    throw new Error('Respuesta inv√°lida del servidor.');
                }

                allItems = normalized;

                // mapa para modal
                itemsByUrl.clear();
                for (const it of allItems) itemsByUrl.set(it.u, it);

                buildFilters();
                render();

                const loader = document.getElementById('loader');
                loader.textContent = loaderDefaultText;
                loader.style.display = 'none';

                retryCount = 0;
                clearStatus();
            } catch (e) {
                retryCount += 1;
                if (retryCount > maxRetries) {
                    showError('‚ùå No se pudo conectar. Verifica tu conexi√≥n y reintenta.');
                    return;
                }
                if (e.name === 'AbortError') {
                    showError(`‚è±Ô∏è Tiempo de espera agotado. Reintentando (${retryCount}/${maxRetries})...`);
                } else if (e.message === 'Respuesta inv√°lida del servidor.') {
                    showError(`‚ö†Ô∏è Respuesta inv√°lida. Reintentando (${retryCount}/${maxRetries})...`);
                } else {
                    showError(`‚ùå Error al conectar. Reintentando (${retryCount}/${maxRetries})...`);
                }
                const delay = baseRetryDelay * retryCount;
                setTimeout(init, delay);
            } finally {
                if (timeoutId) clearTimeout(timeoutId);
                initInProgress = false;
            }
        }

        function buildFilters() {
            const filterBar = document.getElementById('filter-bar');
            const categories = Array.from(new Set(allItems.map(item => item.cat))).sort((a, b) => a.localeCompare(b));
            const pills = [
                { label: 'üöÄ TODO', value: 'TODOS' },
                { label: '‚≠ê FAVS', value: '‚≠ê FAVORITOS' },
                ...categories.map(cat => ({ label: cat, value: cat })),
            ];
            filterBar.innerHTML = pills.map(pill => `
                <div class="pill ${pill.value === currentFilter ? 'active' : ''}" onclick="filterData(${JSON.stringify(pill.value)}, this)">${escapeHtml(pill.label)}</div>
            `).join('');
            if (!pills.some(pill => normalizeCategoryKey(pill.value) === normalizeCategoryKey(currentFilter))) {
                currentFilter = 'TODOS';
                filterBar.querySelector('.pill')?.classList.add('active');
            }
        }

        function render() {
            const container = document.getElementById('container');
            const favs = safeGetFavs();
            let filtered = allItems;

            if (currentFilter === '‚≠ê FAVORITOS') filtered = filtered.filter(i => favs.includes(i.u));
            else if (currentFilter !== 'TODOS') filtered = filtered.filter(i => normalizeCategoryKey(i.cat) === normalizeCategoryKey(currentFilter));

            if (currentSearch) {
                const normalizedSearch = normalizeSearch(currentSearch);
                filtered = filtered.filter(i => normalizeSearch(i.t).includes(normalizedSearch));
            }

            if (lastDropMessage && !lastDropShown) {
                showStatus(lastDropMessage, 2, true);
                lastDropShown = true;
            }

            if (filtered.length === 0) {
                const emptyNote = lastDropMessage ? `<div class="cat-tag">${escapeHtml(lastDropMessage)}</div>` : '';
                container.innerHTML = `
                <div class="card">
                    <div class="info">
                        <div class="title">No hay resultados para mostrar.</div>
                        ${emptyNote}
                    </div>
                </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(i => {
                const safeUrl = JSON.stringify(i.u);
                const safeCat = escapeHtml(i.cat);
                const safeTitle = escapeHtml(i.t);
                const safeImg = escapeHtml(i.img);
                return `
                <div class="card">
                    <div class="logo-container"><img src="${safeImg}" class="logo-img" loading="lazy" onerror="this.src='logo.png'"></div>
                    <div class="info">
                        <div class="cat-tag">${safeCat}</div>
                        <div class="title">${safeTitle}</div>
                    </div>
                    <div class="actions">
                        <button class="btn-fav ${favs.includes(i.u) ? 'active' : ''}" onclick="toggleFav(${safeUrl})">‚òÖ</button>
                        <button class="btn-play" onclick="safeOpenLink(${safeUrl})">VER</button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function normalizeSearch(value) {
            return String(value)
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .toLowerCase();
        }

        function normalizeCategoryKey(value) {
            return normalizeSearch(value).replace(/\s+/g, ' ').trim();
        }

        function toggleFav(url) {
            let favs = safeGetFavs();
            if (favs.includes(url)) favs = favs.filter(f => f !== url);
            else favs.push(url);
            safeSetFavs(favs);
            tg?.HapticFeedback?.impactOccurred?.('light');
            render();
        }

        function filterData(cat, el) {
            document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
            if (el) el.classList.add('active');
            currentFilter = cat;
            render();
        }

        document.getElementById('search').addEventListener('input', (e) => {
            currentSearch = e.target.value;
            render();
        });

        document.getElementById('status-close').addEventListener('click', () => clearStatus());

        // Modal events
        document.getElementById('modalCloseBtn').addEventListener('click', closeInfoModal);
        document.getElementById('modalOkBtn').addEventListener('click', closeInfoModal);
        document.getElementById('modalCopyBtn').addEventListener('click', copyModalText);
        document.getElementById('infoModal').addEventListener('click', (e) => {
            if (e.target && e.target.id === 'infoModal') closeInfoModal();
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeInfoModal();
        });

        tg?.ready?.();
        tg?.expand?.();
        init();
    </script>
</body>
</html>
