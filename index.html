import os, time, threading, requests, hmac, hashlib, urllib.parse
from flask import Flask, request, jsonify
from flask_cors import CORS
from pymongo import MongoClient
from datetime import datetime

# --- CONFIGURACIÓN ---
BOT_TOKEN = os.getenv("TELEGRAM_TOKEN")
MONGO_URI = os.getenv("MONGO_URI")

# Conexión Global Singleton (Optimiza recursos)
try:
    client = MongoClient(MONGO_URI, serverSelectionTimeoutMS=5000)
    db = client['bcntv_database']
    client.admin.command('ping') # Verifica conexión
except Exception as e:
    print(f"CRÍTICO: Error conexión MongoDB: {e}")

app = Flask(__name__)
CORS(app) # Permite comunicación entre GitHub y Render

# --- PROCESO: VALIDACIÓN DE FIRMA ---
def validar_datos_telegram(init_data):
    try:
        parsed = dict(urllib.parse.parse_qsl(init_data))
        hash_recibido = parsed.pop('hash', None)
        data_check_string = "\n".join([f"{k}={v}" for k, v in sorted(parsed.items())])
        
        secret_key = hmac.new(b"WebAppData", BOT_TOKEN.encode(), hashlib.sha256).digest()
        hash_calculado = hmac.new(secret_key, data_check_string.encode(), hashlib.sha256).hexdigest()
        
        return hash_calculado == hash_recibido
    except:
        return False

@app.route('/api/autorizar', methods=['POST'])
def api_auth():
    try:
        data = request.json
        if not validar_datos_telegram(data.get('initData', '')):
            return jsonify({"status": "forbidden"}), 403
            
        uid = str(data.get('uid'))
        # Operación atómica: Actualiza o inserta sin bloquear
        db.suscripciones.update_one(
            {"_id": uid}, 
            {"$set": {"last_active": datetime.now()}}, 
            upsert=True
        )
        return jsonify({"status": "ok"}), 200
    except Exception as e:
        return jsonify({"status": "error", "message": "Error interno"}), 500

if __name__ == "__main__":
    app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 10000)))
