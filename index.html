import os, time, threading, requests
from datetime import datetime, timedelta
from flask import Flask, request, jsonify
from flask_cors import CORS
from bs4 import BeautifulSoup
import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton, WebAppInfo
from pymongo import MongoClient

# --- CONFIGURACI√ìN DE ENTORNO ---
BOT_TOKEN = os.getenv("TELEGRAM_TOKEN")
ADMIN_ID = str(os.getenv("ADMIN_ID"))
ADMIN_USER = os.getenv("ADMIN_USER", "UsuarioSoporte")
MONGO_URI = os.getenv("MONGO_URI")
WEBAPP_URL = "https://bajacousins-lang.github.io/kaelus-app/index.html"
SOURCE_URL = "https://kaelustvsporte.com"

# DB Singleton con optimizaci√≥n de latencia
client = MongoClient(MONGO_URI, serverSelectionTimeoutMS=5000)
db = client['bcntv_database']
cols = {
    "cache": db['cache_contenido'],
    "subs": db['suscripciones'],
    "favs": db['favoritos']
}

bot = telebot.TeleBot(BOT_TOKEN, parse_mode="HTML")
app = Flask(__name__)
# Permitir que la WebApp en GitHub hable con Render
CORS(app, resources={r"/api/*": {"origins": "*"}})

# --- 1. MOTOR DE SCRAPING CON ANALYTICS ---
def motor_scraping():
    session = requests.Session()
    session.headers.update({"User-Agent": "BCNTV-Core/19.0"})
    while True:
        try:
            res = session.get(SOURCE_URL, timeout=12)
            if res.status_code == 200:
                soup = BeautifulSoup(res.text, 'html.parser')
                current = cols['cache'].find_one({"_id": "cache"})
                v_map = {i['u']: i.get('v', 0) for i in current['items']} if current else {}
                
                links = [{"t": a.text.strip()[:60], "u": a['href'], "v": v_map.get(a['href'], 0)} 
                         for a in soup.find_all('a', href=True) if len(a.text.strip()) > 15]
                
                if links:
                    cols['cache'].update_one({"_id": "cache"}, {"$set": {"items": links, "ts": datetime.now()}}, upsert=True)
        except Exception as e:
            print(f"Log Scraper: {e}")
        time.sleep(900)

# --- 2. API PARA WEBAPP (AUTORIZACI√ìN) ---
@app.route('/api/autorizar', methods=['POST'])
def api_auth():
    try:
        data = request.json
        uid = str(data.get('uid'))
        if uid == ADMIN_ID:
            exp = (datetime.now() + timedelta(days=30)).isoformat()
            cols['subs'].update_one({"_id": uid}, {"$set": {"expires": exp}}, upsert=True)
            bot.send_message(uid, "üíé <b>Suscripci√≥n Premium activada v√≠a WebApp.</b>")
            return jsonify({"status": "ok"}), 200
        return jsonify({"status": "unauthorized"}), 403
    except Exception as e:
        return jsonify({"error": str(e)}), 500

# --- 3. L√ìGICA DEL BOT ---
@bot.message_handler(commands=['start'])
def welcome(m):
    kb = InlineKeyboardMarkup(row_width=2)
    kb.add(
        InlineKeyboardButton("üì∫ Abrir App", web_app=WebAppInfo(url=WEBAPP_URL)),
        InlineKeyboardButton("üî• Tendencias", callback_data="v_cat"),
        InlineKeyboardButton("‚≠ê Mis Favoritos", callback_data="v_favs"),
        InlineKeyboardButton("üõ†Ô∏è Soporte", url=f"https://t.me/{ADMIN_USER}")
    )
    bot.send_message(m.chat.id, "<b>Bienvenido a BCNTV Premium</b>\nControl total desde tu bolsillo.", reply_markup=kb)

@bot.callback_query_handler(func=lambda c: c.data == "v_cat")
def show_cat(call):
    data = cols['cache'].find_one({"_id": "cache"})
    if not data:
        bot.answer_callback_query(call.id, "Sincronizando...")
        return
    
    txt = "üî• <b>TOP CONTENIDO HOY:</b>\n\n"
    for i in data['items'][:8]:
        txt += f"‚Ä¢ <a href='{i['u']}'>{i['t']}</a> (üëÅÔ∏è {i.get('v', 0)})\n\n"
        # Analytics at√≥mico en segundo plano
        threading.Thread(target=lambda u=i['u']: cols['cache'].update_one({"_id":"cache","items.u":u}, {"$inc":{"items.$.v":1}}), daemon=True).start()
    
    bot.send_message(call.message.chat.id, txt, disable_web_page_preview=True)
    bot.answer_callback_query(call.id)

@app.route('/health')
def health(): return "OK", 200

if __name__ == "__main__":
    threading.Thread(target=motor_scraping, daemon=True).start()
    threading.Thread(target=lambda: app.run(host='0.0.0.0', port=int(os.environ.get("PORT", 10000))), daemon=True).start()
    bot.infinity_polling(skip_pending=True)
