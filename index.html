<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BCNTV WebPremium</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#141420; --muted:#b7b7c6; --text:#fff;
      --line:#23233a; --pill:#1d1d2e; --accent:#ff3ea5;
      --good:#18d26b; --warn:#ffbf2f; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:rgba(11,11,15,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:5}
    .wrap{max-width:1320px;margin:0 auto;padding:14px 16px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:#111;object-fit:cover;border:1px solid var(--line)}
    .title{font-weight:800;letter-spacing:.3px}
    .vip{font-size:12px;color:var(--muted)}
    .vip b{color:var(--good)}
    .bar{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    input[type="search"]{
      flex:1;min-width:220px;padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      background:#0f0f18;color:var(--text);outline:none
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:var(--pill);
      color:var(--text);cursor:pointer;font-weight:800;font-size:13px
    }
    .tab.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,62,165,.15) inset}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0f0f18;color:var(--text);
      outline:none
    }
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;padding:14px 0}
    .section{grid-column:1/-1;margin-top:10px}
    .section h2{margin:0 0 10px 0;font-size:15px;color:#f2f2ff;letter-spacing:.2px}
    .section h2 .sub{color:var(--muted);font-weight:650}
    .card{
      grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:18px;
      overflow:hidden;padding:12px;position:relative;

      display:grid;
      grid-template-columns:96px 1fr;
      grid-template-areas:
        "poster meta"
        "actions actions";
      gap:12px;
      align-items:start;
    }
    @media(min-width:720px){ .card{grid-column:span 6} }
    @media(min-width:980px){ .card{grid-column:span 4} }
    @media(max-width:520px){
      .card{
        grid-template-columns:1fr;
        grid-template-areas:
          "poster"
          "meta"
          "actions";
      }
      .posterBox{grid-area:poster;width:100%;height:190px;border-radius:14px;overflow:hidden;border:1px solid var(--line);background:#0f0f18}
    .posterBox svg{width:100%;height:100%;display:block}
      .actions{justify-content:flex-start}
    }

    .posterBox{grid-area:poster;width:96px;height:136px;border-radius:14px;border:1px solid var(--line);background:#0f0f18;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .posterImg{width:100%;height:100%;object-fit:cover;display:block}
    .posterBox svg{width:100%;height:100%;display:block}
    .posterEmojiWrap{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px}
    .posterEmojiWrap .pe{font-size:64px;line-height:1}
    .posterEmojiWrap .pl{font-size:13px;letter-spacing:.14em;text-transform:uppercase;color:rgba(255,255,255,.75)}

    .meta{grid-area:meta;min-width:0}
    .t{font-weight:900;margin:0 0 6px 0;font-size:15px;line-height:1.25}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;margin-right:6px;margin-bottom:6px}
    .pill.live{border-color:rgba(24,210,107,.5);color:#eafff3}
    .pill.warn{border-color:rgba(255,191,47,.55);color:#fff6d8}
    .line{color:var(--muted);font-size:12px;line-height:1.35;word-break:break-word}
    .solid{height:1px;background:rgba(255,255,255,.15);margin:6px 0 8px 0}
    .light{height:1px;background:rgba(255,255,255,.08);margin:8px 0}
    .actions{grid-area:actions;display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-direction:row;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);background:#0f0f18;color:#fff;border-radius:12px;
      padding:9px 10px;cursor:pointer;font-weight:900;font-size:12px;white-space:nowrap
    }
    .btn.small{padding:7px 9px;font-size:12px}
    .btn.on{border-color:var(--warn);box-shadow:0 0 0 2px rgba(255,191,47,.12) inset}
    .btn.disabled{opacity:.45;cursor:not-allowed}
    .btn.primary{border-color:rgba(255,62,165,.65);box-shadow:0 0 0 2px rgba(255,62,165,.12) inset}
    .footer{padding:22px 0;color:var(--muted);font-size:12px;border-top:1px solid var(--line);margin-top:18px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:12px}
    .badge.good b{color:var(--good)}

    .lock{
      position:absolute;inset:0;background:rgba(0,0,0,.65);
      display:flex;align-items:center;justify-content:center;text-align:center;padding:14px;
    }
    .lock .box{
      max-width:270px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);border-radius:14px;padding:12px;
    }
    .lock .box h4{margin:0 0 6px 0;font-size:14px}
    .lock .box p{margin:0;color:#e8e8f2;font-size:12px;line-height:1.35}
  
    .megaphone{color:var(--muted); margin-right:6px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img class="logo" id="logo" src="./logo.png" alt="logo"
             onerror="this.src='https://bajacousins-lang.github.io/kaelus-app/logo.png'"/>
        <div>
          <div class="title">BCNTV WebPremium</div>
          <div class="vip" id="vipLine">Estado: <b>VIP</b></div>
        </div>
      </div>

      <div class="row">
        <div class="badge good" id="statusBadge">‚óè <span id="statusText">Conectando‚Ä¶</span></div>
        <button class="tab" id="btnConfig" type="button" title="Configurar API/VIP">‚öôÔ∏è Config</button>
      </div>
    </div>

    <div class="bar">
      <input id="q" type="search" placeholder="Buscar por t√≠tulo, canal, estadio, liga (LaLiga), etc‚Ä¶"/>
      <div class="tabs">
        <button class="tab active" data-tab="all">Todo</button>
        <button class="tab" data-tab="favs">Favoritos</button>
        <button class="tab" data-tab="sports">Deportes</button>
        <button class="tab" data-tab="movies">Pel√≠culas</button>
        <button class="tab" data-tab="series">Series</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <select id="sportsSub">
        <option value="">Subfiltro deportes: Todos</option>
        <option value="LaLiga">LaLiga</option>
        <option value="Liga MX">Liga MX</option>
        <option value="COMBATE">Combate</option>
        <option value="GRAND">Tenis/Grand Slams</option>
        <option value="GOLF">Golf</option>
      </select>

      <select id="vipFilter">
        <option value="show_locked">VIP: mostrar (bloqueados si no tienes)</option>
        <option value="show">VIP: mostrar solo si tienes</option>
        <option value="hide">VIP: ocultar</option>
        <option value="only">VIP: solo VIP (si tienes)</option>
      </select>

      <div class="small">Auto-refresh cada 15 min ‚Ä¢ Favoritos guardados en tu dispositivo</div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="hint" id="apiHint"></div>
  <div class="grid" id="grid"></div>

  <div class="footer">
    <div>Tips: En deportes puedes descargar recordatorios (ICS) a 5/10/15 min antes. Si el evento ya inici√≥, esos botones se desactivan.</div>
  </div>
</main>

<script>
  // ===== Config =====
  const params = new URLSearchParams(location.search);

  // VIP persistente: ?vip=1 / ?vip=0
  let VIP = (function(){
    const v = (params.get("vip") || "").toLowerCase();
    if(v === "1" || v === "true") localStorage.setItem("BCNTV_VIP", "1");
    if(v === "0" || v === "false") localStorage.removeItem("BCNTV_VIP");
    return localStorage.getItem("BCNTV_VIP") === "1";
  })();

  // Backend por defecto:
  // - En GitHub Pages (github.io) usamos el backend p√∫blico.
  // - Si se hospeda en otro dominio (p.ej. el mismo backend), usamos location.origin.
  const IS_GH_PAGES = ((location.hostname || "").toLowerCase().endsWith("github.io"));
  const DEFAULT_API_BASE = (function(){
    if(location.protocol === "file:") return "https://kaelus-bot.onrender.com";
    if(IS_GH_PAGES) return "https://kaelus-bot.onrender.com";
    return location.origin;
  })();

  // API base persistente + soporte ?api=...
  let API_BASE = (function(){
    const p = (params.get("api") || "").trim();
    if(p) localStorage.setItem("BCNTV_API_BASE", p);
    return (localStorage.getItem("BCNTV_API_BASE") || DEFAULT_API_BASE).replace(/\/$/,"");
  })();

  // API key opcional (x-api-key) + ?key=...
  let API_KEY = (function(){
    const k = (params.get("key") || "").trim();
    if(k) localStorage.setItem("BCNTV_API_KEY", k);
    return (localStorage.getItem("BCNTV_API_KEY") || "").trim();
  })();

  let API_URL = API_BASE + "/api/links";

  function applyUiConfig(){
    document.getElementById("vipLine").innerHTML = "Estado: " + (VIP ? "<b>VIP</b>" : "<span style='color:var(--bad);font-weight:900'>No VIP</span>");
    const keyInfo = API_KEY ? " (key: s√≠)" : " (key: no)";
    document.getElementById("apiHint").textContent = "API: " + API_URL + keyInfo;
  }
  applyUiConfig();

  const grid = document.getElementById("grid");
  const q = document.getElementById("q");
  const sportsSub = document.getElementById("sportsSub");
  const vipFilter = document.getElementById("vipFilter");
  const tabs = [...document.querySelectorAll(".tab")];

  let TAB = "all";
  let DATA = [];
  let FAVS = loadFavs();

  function vibrate(ms=12){ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch(e){} }

  tabs.forEach(b=>{
    b.addEventListener("click", ()=>{
      vibrate(10);
      tabs.forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      TAB = b.dataset.tab;
      render();
    });
  });

  q.addEventListener("input", ()=> render());
  sportsSub.addEventListener("change", ()=> render());
  vipFilter.addEventListener("change", ()=> render());

  document.getElementById("btnConfig").addEventListener("click", ()=>{
    try{ vibrate(12); }catch(e){}
    const api = prompt("API Base URL (ej: https://kaelus-bot.onrender.com)", API_BASE);
    if(api !== null){
      const v = (api || "").trim();
      if(v) localStorage.setItem("BCNTV_API_BASE", v);
      API_BASE = (localStorage.getItem("BCNTV_API_BASE") || DEFAULT_API_BASE).replace(/\/$/,"");
      API_URL = API_BASE + "/api/links";
    }

    const key = prompt("API Key (x-api-key). Deja vac√≠o si no usas:", API_KEY);
    if(key !== null){
      const k = (key || "").trim();
      if(k) localStorage.setItem("BCNTV_API_KEY", k);
      else localStorage.removeItem("BCNTV_API_KEY");
      API_KEY = (localStorage.getItem("BCNTV_API_KEY") || "").trim();
    }

    const vip = confirm("¬øActivar VIP en este dispositivo?\nOK = VIP\nCancelar = No VIP");
    if(vip) localStorage.setItem("BCNTV_VIP","1"); else localStorage.removeItem("BCNTV_VIP");
    VIP = localStorage.getItem("BCNTV_VIP")==="1";

    applyUiConfig();
    fetchData();
  });

  function loadFavs(){
    try{ return JSON.parse(localStorage.getItem("bcntv_favs")||"[]"); }
    catch(e){ return []; }
  }
  function saveFavs(){ localStorage.setItem("bcntv_favs", JSON.stringify(FAVS)); }
  function isFav(id){ return FAVS.includes(id); }
  function toggleFav(id){
    vibrate(18);
    if(isFav(id)) FAVS = FAVS.filter(x=>x!==id);
    else FAVS.push(id);
    saveFavs();
    render();
  }

  function setStatus(ok, msg){
    const badge = document.getElementById("statusBadge");
    const text = document.getElementById("statusText");
    text.textContent = msg;
    badge.style.borderColor = ok ? "rgba(24,210,107,.5)" : "rgba(255,107,107,.5)";
  }

  async function fetchData(){
    try{
      setStatus(true, "Cargando‚Ä¶");
      const headers = {};
      if(API_KEY) headers["x-api-key"] = API_KEY;

      const r = await fetch(API_URL, {cache:"no-store", headers});
      if(!r.ok) throw new Error("HTTP " + r.status);
      const j = await r.json();
      DATA = Array.isArray(j) ? j : [];

      try{ localStorage.setItem("BCNTV_CACHE_ITEMS", JSON.stringify(DATA)); }catch(e){}
      setStatus(true, "Online (" + DATA.length + ")");
      render();
    }catch(e){
      console.error(e);
      const cached = localStorage.getItem("BCNTV_CACHE_ITEMS");
      if(cached){
        try{
          DATA = JSON.parse(cached) || [];
          setStatus(false, "Offline (cach√© " + DATA.length + ")");
          render();
          return;
        }catch(_){}
      }
      setStatus(false, "Offline");
      render();
    }
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function safeLower(s){ return (s||"").toLowerCase(); }

  // Lee id estable del item (back-compat: _id o id)
  function itemId(it){
    try{
      if(!it || typeof it !== "object") return "";
      const v = (it._id ?? it.id ?? (it.meta && (it.meta._id ?? it.meta.id)) ?? "");
      if(v !== null && v !== undefined && String(v).trim()) return String(v).trim();
      // fallback (solo para evitar crash): t√≠tulo + categor√≠a
      const t = String(it.t || "").trim();
      const c = String(it.cat || "").trim();
      return (t && c) ? (t + "|" + c) : (t || c || "");
    }catch(e){
      return "";
    }
  }


  // ===== Im√°genes (placeholders + posters Zuplo) =====
  function svgInline(svg){
    return String(svg||"").trim();
  }
// Placeholders (evitan usar el logo)
  const IMG_PLACEHOLDER_MOVIE = svgInline(`
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
      <defs>
        <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0" stop-color="#141420"/>
          <stop offset="1" stop-color="#0f0f18"/>
        </linearGradient>
      </defs>
      <rect width="420" height="280" rx="28" fill="url(#g)"/>
      <rect x="34" y="34" width="352" height="212" rx="18" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.10)"/>
      <path d="M170 110h80v60h-80z" fill="rgba(255,255,255,.08)"/>
      <path d="M172 113l75 27-75 27z" fill="rgba(255,255,255,.22)"/>
      <text x="210" y="235" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto,Arial" font-size="20" fill="rgba(255,255,255,.55)">PEL√çCULA</text>
    </svg>
  `);

  const IMG_PLACEHOLDER_SERIES = svgInline(`
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
      <defs>
        <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0" stop-color="#141420"/>
          <stop offset="1" stop-color="#0f0f18"/>
        </linearGradient>
      </defs>
      <rect width="420" height="280" rx="28" fill="url(#g)"/>
      <rect x="44" y="52" width="332" height="176" rx="18" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.10)"/>
      <rect x="64" y="78" width="292" height="126" rx="14" fill="rgba(255,255,255,.06)"/>
      <path d="M190 115h60v48h-60z" fill="rgba(255,255,255,.10)"/>
      <path d="M192 118l56 21-56 21z" fill="rgba(255,255,255,.24)"/>
      <text x="210" y="245" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto,Arial" font-size="20" fill="rgba(255,255,255,.55)">SERIE</text>
    </svg>
  `);

  const IMG_PLACEHOLDER_SPORT = svgInline(`
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
      <defs>
        <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
          <stop offset="0" stop-color="#141420"/>
          <stop offset="1" stop-color="#0f0f18"/>
        </linearGradient>
      </defs>
      <rect width="420" height="280" rx="28" fill="url(#g)"/>
      <circle cx="210" cy="135" r="64" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.12)" stroke-width="8"/>
      <path d="M210 76c22 10 38 30 38 59s-16 49-38 59c-22-10-38-30-38-59s16-49 38-59z" fill="rgba(255,255,255,.10)"/>
      <text x="210" y="235" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto,Arial" font-size="20" fill="rgba(255,255,255,.55)">DEPORTE</text>
    </svg>
  `);

  // Ilustraciones simples por deporte (evitan logos por canal)
  const SPORT_ILLUSTRATIONS = {
    soccer: svgInline(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
        <rect width="420" height="280" rx="28" fill="#0f0f18"/>
        <rect x="34" y="34" width="352" height="212" rx="18" fill="rgba(255,255,255,.04)" stroke="rgba(255,255,255,.10)"/>
        <circle cx="210" cy="140" r="64" fill="rgba(255,255,255,.05)" stroke="rgba(255,255,255,.18)" stroke-width="10"/>
        <path d="M210 98l32 24-12 38h-40l-12-38z" fill="rgba(255,255,255,.18)"/>
        <path d="M178 122l-22 18 10 30 24-10m76-38l22 18-10 30-24-10" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `),
    basketball: svgInline(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
        <rect width="420" height="280" rx="28" fill="#0f0f18"/>
        <circle cx="210" cy="140" r="78" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.18)" stroke-width="10"/>
        <path d="M210 62v156M132 140h156" stroke="rgba(255,255,255,.22)" stroke-width="10" stroke-linecap="round"/>
        <path d="M165 75c35 30 35 120 0 150M255 75c-35 30-35 120 0 150" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="10" stroke-linecap="round"/>
      </svg>
    `),
    football: svgInline(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
        <rect width="420" height="280" rx="28" fill="#0f0f18"/>
        <ellipse cx="210" cy="140" rx="112" ry="72" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.18)" stroke-width="10"/>
        <path d="M140 140h140" stroke="rgba(255,255,255,.20)" stroke-width="10" stroke-linecap="round"/>
        <path d="M190 120h40v40h-40z" fill="rgba(255,255,255,.12)"/>
        <path d="M190 140h40" stroke="rgba(255,255,255,.24)" stroke-width="8" stroke-linecap="round"/>
        <path d="M202 132v16M218 132v16" stroke="rgba(255,255,255,.24)" stroke-width="6" stroke-linecap="round"/>
      </svg>
    `),
    baseball: svgInline(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
        <rect width="420" height="280" rx="28" fill="#0f0f18"/>
        <circle cx="210" cy="140" r="78" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.18)" stroke-width="10"/>
        <path d="M165 88c22 18 22 86 0 104M255 88c-22 18-22 86 0 104" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="10" stroke-linecap="round"/>
        <path d="M182 110c10 6 10 54 0 60M238 110c-10 6-10 54 0 60" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="8" stroke-linecap="round"/>
      </svg>
    `),
    tennis: svgInline(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
        <rect width="420" height="280" rx="28" fill="#0f0f18"/>
        <circle cx="210" cy="140" r="74" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.18)" stroke-width="10"/>
        <path d="M148 120c32 0 48 18 48 44s-16 44-48 44" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="10" stroke-linecap="round"/>
        <path d="M272 120c-32 0-48 18-48 44s16 44 48 44" fill="none" stroke="rgba(255,255,255,.22)" stroke-width="10" stroke-linecap="round"/>
      </svg>
    `),
    golf: svgInline(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
        <rect width="420" height="280" rx="28" fill="#0f0f18"/>
        <path d="M135 210h170" stroke="rgba(255,255,255,.12)" stroke-width="10" stroke-linecap="round"/>
        <path d="M195 70v140" stroke="rgba(255,255,255,.20)" stroke-width="10" stroke-linecap="round"/>
        <path d="M195 72l88 42-88 34z" fill="rgba(255,255,255,.14)"/>
        <circle cx="270" cy="206" r="18" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)" stroke-width="8"/>
      </svg>
    `),
    combat: svgInline(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
        <rect width="420" height="280" rx="28" fill="#0f0f18"/>
        <path d="M145 170c0-30 20-55 55-55h28c26 0 47 21 47 47v34c0 22-18 40-40 40h-62c-15 0-28-12-28-28z"
              fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)" stroke-width="10" stroke-linejoin="round"/>
        <path d="M205 110v126" stroke="rgba(255,255,255,.18)" stroke-width="10" stroke-linecap="round"/>
      </svg>
    `),
    motorsport: svgInline(`
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 420 280">
        <rect width="420" height="280" rx="28" fill="#0f0f18"/>
        <path d="M120 170h160l40 24h-200z" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.18)" stroke-width="10" stroke-linejoin="round"/>
        <circle cx="170" cy="204" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.20)" stroke-width="10"/>
        <circle cx="270" cy="204" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.20)" stroke-width="10"/>
        <path d="M150 148h120" stroke="rgba(255,255,255,.18)" stroke-width="10" stroke-linecap="round"/>
      </svg>
    `),
  };

  function isLogoUrl(u){
    const s = String(u || "").trim();
    if(!s) return true;
    const low = s.toLowerCase();
    if(low === "./logo.png" || low.endsWith("/logo.png") || low.includes("kaelus-app/logo.png")) return true;
    // algunos backends devuelven LOGO_URL p√∫blico
    if(low.includes("logo.png") && low.includes("github")) return true;
    return false;
  }

  // Cache local de posters (para no pedirlo cada render)
  let POSTER_LOCAL = (function(){
    try{ return JSON.parse(localStorage.getItem("BCNTV_POSTER_CACHE")||"{}") || {}; }
    catch(e){ return {}; }
  })();
  function savePosterLocal(){
    try{ localStorage.setItem("BCNTV_POSTER_CACHE", JSON.stringify(POSTER_LOCAL)); }catch(e){}
  }

  const POSTER_QUEUE = [];
  let POSTER_TIMER = null;

  function sportIllustrationKey(it){
    const m = (it && it.meta) ? it.meta : {};
    const blob = ((m.competition||"") + " " + (it.cat||"") + " " + (m.raw||"") + " " + (it.t||"")).toLowerCase();

    // Soccer / f√∫tbol
    if(blob.includes("futbol") || blob.includes("f√∫tbol") || blob.includes("soccer") ||
       blob.includes("laliga") || blob.includes("liga mx") || blob.includes("champions") || blob.includes("uefa")) return "soccer";

    // Otros deportes populares
    if(blob.includes("nba") || blob.includes("basket")) return "basketball";
    if(blob.includes("nfl") || blob.includes("football americano") || blob.includes("super bowl")) return "football";
    if(blob.includes("mlb") || blob.includes("beisbol") || blob.includes("b√©isbol") || blob.includes("baseball")) return "baseball";
    if(blob.includes("tenis") || blob.includes("wimbledon") || blob.includes("roland") || blob.includes("atp") || blob.includes("wta") || blob.includes("grand")) return "tennis";
    if(blob.includes("golf") || blob.includes("pga") || blob.includes("liv golf") || blob.includes("masters")) return "golf";

    // Combate / lucha
    if(blob.includes("ufc") || blob.includes("mma") || blob.includes("boxeo") || blob.includes("boxing") ||
       blob.includes("combate") || blob.includes("wwe") || blob.includes("aew") || blob.includes("bellator")) return "combat";

    // Motor
    if(blob.includes("f1") || blob.includes("formula") || blob.includes("motogp") || blob.includes("moto gp") ||
       blob.includes("nascar") || blob.includes("rally") || blob.includes("moto")) return "motorsport";

    return "soccer";
  }

  function isHttpUrl(u){
    const s = String(u||"").trim();
    return /^https?:\/\//i.test(s);
  }

function looksLikeImageUrl(u){
    const s = String(u||"").trim();
    if(!s) return false;

    // reject common video/playlist urls
    if(/\.(m3u8|mpd|mp4|mkv|avi|ts|m4v|mov|webm)(\?|#|$)/i.test(s)) return false;
    if(/m3u8|\.mpd/i.test(s)) return false;

    // our proxy is always an image response (or svg placeholder)
    if(s.includes("/api/poster_img")) return true;

    // TMDB CDN
    if(/image\.tmdb\.org/i.test(s)) return true;

    // common image extensions
    if(/\.(jpg|jpeg|png|webp|gif|bmp|svg)(\?|#|$)/i.test(s)) return true;

    return false;
  }

  function isPosterCandidate(u){
    const s = String(u||"").trim();
    if(!isHttpUrl(s)) return false;
    if(isLogoUrl(s)) return false;
    return looksLikeImageUrl(s);
  }


  function normalizePosterQueryTitle(raw){
    let s = String(raw||"").trim();

    // Quitar ruido com√∫n en t√≠tulos del cat√°logo (solo para consulta a posters)
    // Ejemplos: "Dual", "(2026)", "2026"
    s = s.replace(/\bdual\b/ig, " ");
    s = s.replace(/\((19|20)\d{2}\)/g, " ");
    s = s.replace(/\[(19|20)\d{2}\]/g, " ");
    s = s.replace(/\b(19|20)\d{2}\b/g, " ");

    // Normalizar espacios
    s = s.replace(/\s+/g, " ").trim();
    return s;
  }

  // Reintento para posters (Render puede responder HTML mientras "despierta"; la imagen falla y disparar√≠a onerror).
  // Intentamos varias veces con cache-busting antes de rendirnos al fallback.
  function retryPoster(img){
    try{
      const max = 4;
      const n = parseInt(img.getAttribute("data-retry") || "0", 10);
      const base = img.getAttribute("data-sbase") || img.getAttribute("src") || "";
      if(n < max && base){
        img.setAttribute("data-retry", String(n+1));
        img.setAttribute("data-sbase", base.split(/([&?])r=\d+/).join("")); // limpia r=
        const clean = img.getAttribute("data-sbase") || base;
        const sep = clean.includes("?") ? "&" : "?";
        setTimeout(()=>{ img.setAttribute("src", clean + sep + "r=" + Date.now()); }, 650);
        return;
      }
      // fallback final
      const box = img.parentElement;
      const b = box && box.getAttribute("data-fb");
      if(b) box.innerHTML = decodeURIComponent(b);
    }catch(e){
      // silencioso
    }
  }

function posterHtml(iid, imgInfo){
    const pid = `poster-${iid}`;

    // Imagen real (http/https)
    if(imgInfo && imgInfo.mode === "img" && isHttpUrl(imgInfo.src)){
      const src = escapeHtml(imgInfo.src);
      // fallback puede ser SVG o HTML (emoji)
      const fb = encodeURIComponent(String(imgInfo.fallbackHtml || imgInfo.fallbackSvg || "").trim());
      const fbAttr = escapeHtml(fb);

      return `<div class="posterBox" id="${escapeHtml(pid)}" data-fb="${fbAttr}">` +
             `<img id="img-${escapeHtml(iid)}" class="posterImg" loading="lazy" src="${src}" data-sbase="${src}" data-retry="0" alt="" ` +
             `onerror="retryPoster(this)"/>` +
             `</div>`;
    }

    // Placeholder HTML (emoji/label) ‚Äî ultra robusto
    if(imgInfo && imgInfo.mode === "emoji"){
      const em = escapeHtml(imgInfo.emoji || "üñºÔ∏è");
      const label = escapeHtml(imgInfo.label || "");
      const inner = `<div class="posterEmojiWrap"><div class="pe">${em}</div>` + (label?`<div class="pl">${label}</div>`:"") + `</div>`;
      return `<div class="posterBox" id="${escapeHtml(pid)}">${inner}</div>`;
    }

    // SVG inline (si existe)
    const svg = (imgInfo && imgInfo.svg) ? imgInfo.svg : "";
    const safeSvg = String(svg||"").trim() || String(imgInfo && imgInfo.fallbackSvg || "").trim() || "";
    // Si no hay SVG, caemos a emoji gen√©rico
    if(!safeSvg){
      const inner = `<div class="posterEmojiWrap"><div class="pe">üñºÔ∏è</div></div>`;
      return `<div class="posterBox" id="${escapeHtml(pid)}">${inner}</div>`;
    }
    return `<div class="posterBox" id="${escapeHtml(pid)}">${safeSvg}</div>`;
  }

  function resolveCardImage(it){
    const m = it.meta || {};
    let type = String(m.type || "").toLowerCase();

    // Back-compat: si falta meta.type, inferimos por cat o por campos t√≠picos
    if(!type){
      const cat = String(it.cat || "").toLowerCase();
      if(cat.includes("deport")) type = "sport";
      else if(cat.includes("pel")) type = "movie";
      else if(cat.includes("seri")) type = "series";
      else{
        // heur√≠stica: si parece evento deportivo
        if(m.start_utc || m.competition || m.hora_text || m.categoria || m.is_live_now) type = "sport";
      }
    }

    // Deportes: emoji representativo (siempre visible)
    if(type === "sport"){
      const key = sportIllustrationKey(it);
      const emoji =
        key === "soccer" ? "‚öΩ" :
        key === "basketball" ? "üèÄ" :
        key === "football" ? "üèà" :
        key === "baseball" ? "‚öæ" :
        key === "tennis" ? "üéæ" :
        key === "golf" ? "‚õ≥" :
        key === "combat" ? "ü•ä" :
        key === "motor" ? "üèéÔ∏è" :
        "üèüÔ∏è";
      return { mode:"emoji", emoji, label:"DEPORTE", needsFetch:false };
    }

    // VOD: poster real (https/http) o placeholder emoji (NO logo)
    if(type === "movie" || type === "series"){
      const zu = (m.art && typeof m.art === "object") ? m.art : {};
      const titleClean = String(m.title_clean || m.title || m.titulo || m.name || m.nombre || (m.info && (m.info.title || m.info.titulo || m.info.name || m.info.nombre)) || it.t || it.title || it.titulo || it.name || it.nombre || "").trim();
      const qTitle = normalizePosterQueryTitle(titleClean);
      const kind = (type === "series") ? "tv" : "movie";
      const cacheKey = `${kind}:${qTitle.toLowerCase()}`;

      const placeholder = (type === "series")
        ? { mode:"emoji", emoji:"üì∫", label:"SERIE" }
        : { mode:"emoji", emoji:"üé¨", label:"PEL√çCULA" };

      let src = POSTER_LOCAL[cacheKey] || zu.poster_img || zu.poster || zu.img || zu.url || zu.backdrop || "";
      if(!isPosterCandidate(src)) src = "";

      // Si no hay arte embebido, usa directamente el proxy del backend (TMDB) para que SIEMPRE haya poster en Pel√≠culas/Series.
      // Esto evita depender de la cola async /api/poster (que puede quedar bloqueada por cach√© o datos incompletos).
      if(!src && qTitle){
        src = `${API_BASE}/api/poster_img?title=${encodeURIComponent(qTitle)}&type=${encodeURIComponent(kind)}`;
      }

      const needsFetch = false;

      if(src && isHttpUrl(src)){
        return {
          mode:"img",
          src,
          fallbackHtml: `<div class="posterEmojiWrap"><div class="pe">${placeholder.emoji}</div><div class="pl">${placeholder.label}</div></div>`,
          needsFetch:false,
          titleClean,
          kind,
          cacheKey
        };
      }

      // Sin URL: placeholder emoji (y opcionalmente buscamos en Zuplo)
      return {
        ...placeholder,
        needsFetch,
        titleClean,
        kind,
        cacheKey
      };
    }

    // Fallback general
    return { mode:"emoji", emoji:"üñºÔ∏è", label:"", needsFetch:false };
  }



  function queuePosterFetch(iid, titleClean, kind, cacheKey){
    if(!titleClean) return;
    const key = cacheKey || `${kind}:${titleClean.toLowerCase()}`;
    const cached = POSTER_LOCAL[key];
    if(cached){
      // Si el cache tiene logo o algo que no parece imagen, lo ignoramos y lo volvemos a pedir
      if(isLogoUrl(cached) || (isHttpUrl(cached) && !looksLikeImageUrl(cached))){
        delete POSTER_LOCAL[key];
      }else{
        return;
      }
    }
    if(POSTER_QUEUE.some(x => x.key === key)) return;

    POSTER_QUEUE.push({iid, titleClean, kind, key});
    if(!POSTER_TIMER) POSTER_TIMER = setTimeout(processPosterQueue, 60);
  }

  async function processPosterQueue(){
    POSTER_TIMER = null;
    const batch = POSTER_QUEUE.splice(0, 10);
    if(!batch.length) return;

    const headers = {};
    if(API_KEY) headers["x-api-key"] = API_KEY;

    for(const job of batch){
      try{
        const url = `${API_BASE}/api/poster?title=${encodeURIComponent(job.titleClean)}&type=${encodeURIComponent(job.kind)}`;
        const r = await fetch(url, {headers, cache:"no-store"});
        if(!r.ok) continue;
        const j = await r.json();
        const poster = (j && (j.poster_img || j.poster || j.img || j.url || j.backdrop || j.thumb)) ? String(j.poster_img || j.poster || j.img || j.url || j.backdrop || j.thumb) : "";
        if(!poster || isLogoUrl(poster) || (isHttpUrl(poster) && !looksLikeImageUrl(poster))) continue;

        POSTER_LOCAL[job.key] = poster;

        const posterBox = document.getElementById(`poster-${job.iid}`);
        if(!posterBox) continue;

        const imgEl = posterBox.querySelector("img");
        if(imgEl){
          imgEl.setAttribute("src", poster);
        }else{
          // si todav√≠a est√° en SVG placeholder, reemplazamos por <img>
          const placeholderHtml = (job.kind === "tv") ? `<div class=\"posterEmojiWrap\"><div class=\"pe\">üì∫</div><div class=\"pl\">SERIE</div></div>` : `<div class=\"posterEmojiWrap\"><div class=\"pe\">üé¨</div><div class=\"pl\">PEL√çCULA</div></div>`;
          posterBox.setAttribute("data-fb", encodeURIComponent(String(placeholderHtml||"").trim()));
          posterBox.innerHTML =
            `<img id="img-${escapeHtml(job.iid)}" class="posterImg" loading="lazy" src="${escapeHtml(poster)}" data-sbase="${escapeHtml(poster)}" data-retry="0" alt="" ` +
            `onerror="retryPoster(this)"/>`;
        }
      }catch(e){
        console.warn("poster fetch error", e);
      }
    }

    savePosterLocal();
    if(POSTER_QUEUE.length) POSTER_TIMER = setTimeout(processPosterQueue, 120);
  }



  function escapeRegExp(s){
    return (s||"").replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  function buildCanalesTxt(m, type){
    const canales0 = Array.isArray(m.canales) ? m.canales : (m.canal ? [m.canal] : []);
    let cat = (type === "sport") ? String(m.categoria||"").trim() : "";
    const clean = [];
    for(const c of canales0){
      let s = String(c||"").trim();
      if(!s) continue;
      s = s.replace(/\s+/g, " ");
      if(/^y$/i.test(s)) continue;
      const mm = s.match(/^(?:y\s+)?(?:por\s+)?categor[i√≠]a\s*(.+)$/i);
      if(mm){
        const cand = (mm[1]||"").trim();
        if(!cat && cand) cat = cand;
        continue;
      }
      clean.push(s);
    }
    // dedupe preservando orden
    const seen = new Set();
    const uniq = [];
    for(const s of clean){
      const k = s.toLowerCase();
      if(seen.has(k)) continue;
      seen.add(k);
      uniq.push(s);
    }
    let canalesTxt = uniq.length ? uniq.join(", ") : "";
    if(type === "sport" && cat){
      const re = new RegExp("\\bcategor[i√≠]a\\s+" + escapeRegExp(cat) + "\\b","i");
      if(!re.test(canalesTxt)){
        canalesTxt = canalesTxt.replace(/\s+y\s*$/i, "").trim();
        canalesTxt = canalesTxt ? (canalesTxt + ` y por Categor√≠a ${cat}`) : (`Por Categor√≠a ${cat}`);
      }
    }
    canalesTxt = canalesTxt.replace(/\by\s+y\b/ig, "y");
    return canalesTxt;
  }

  function textOfItem(it){
    const t = (it.t||"");
    const cat = (it.cat||"");
    const m = it.meta||{};
    const isSport = !!(m.competition || m.hora_text || m.start_utc || m.categoria);
    const canales = buildCanalesTxt(m, isSport ? "sport" : "media");
    return (t+" "+cat+" "+canales+" "+(m.sede||"")+" "+(m.competition||"")+" "+(m.jornada||"")+" "+(m.section||"")+" "+(m.super_section||"")+" "+(m.date_label||"")).toLowerCase();
  }

  function allowByVip(it){
    const m = it.meta || {};
    const isVipItem = !!m.is_vip;
    const mode = vipFilter.value;

    if(mode === "show_locked") return true;
    if(mode === "show") return !isVipItem || VIP;
    if(mode === "hide") return !isVipItem;
    if(mode === "only") return isVipItem && VIP;
    return true;
  }

  function filterItems(){
    const term = (q.value||"").trim().toLowerCase();
    let arr = DATA.slice();

    arr = arr.filter(allowByVip);

    if(TAB === "sports"){
      arr = arr.filter(x => (x.meta && x.meta.type === "sport") || (x.cat||"").includes("DEPORT") || (x.cat||"").includes("LaLiga") || (x.cat||"").includes("Liga MX"));
      const sub = sportsSub.value;
      if(sub){
        if(sub === "COMBATE") arr = arr.filter(x => (x.cat||"").includes("COMBATE"));
        else if(sub === "GRAND") arr = arr.filter(x => (x.cat||"").includes("GRAND"));
        else if(sub === "GOLF") arr = arr.filter(x => (x.cat||"").includes("GOLF"));
        else arr = arr.filter(x => (x.meta && x.meta.competition === sub) || (x.cat||"").includes(sub));
      }
    }
    if(TAB === "movies"){
      arr = arr.filter(x => (x.meta && x.meta.type === "movie") || String(x.cat||"").toUpperCase().includes("PEL"));
    }
    if(TAB === "series"){
      arr = arr.filter(x => (x.meta && x.meta.type === "series") || String(x.cat||"").toUpperCase().includes("SER"));
    }
    if(TAB === "favs"){
      arr = arr.filter(x => isFav(itemId(x)));
    }

    if(term) arr = arr.filter(x => textOfItem(x).includes(term));
    return arr;
  }

  function groupSports(arr){
    const groups = new Map();
    for(const it of arr){
      const m = it.meta||{};
      const comp = m.competition || "Deportes";
      if(!groups.has(comp)) groups.set(comp, []);
      groups.get(comp).push(it);
    }
    return groups;
  }

    // VOD: date -> super_section -> blocks (orden preservado)
  function groupVOD(arr){
    const out = new Map();

    // Preservamos orden del feed si viene meta.order (si no, queda estable)
    const sorted = arr.slice().sort((a,b)=>{
      const ao = (a.meta && Number.isFinite(+a.meta.order)) ? +a.meta.order : 0;
      const bo = (b.meta && Number.isFinite(+b.meta.order)) ? +b.meta.order : 0;
      return ao - bo;
    });

    // Agrupa por: fecha -> super_section -> g√©nero (sin repetir encabezados)
    for(const it of sorted){
      const m = it.meta||{};
      const date = (m.date_label || "").trim();
      let superS = (m.super_section || (m.type==="series" ? "Nuevas Series" : "Nuevas Peliculas")).trim();
      if(/episod/i.test(superS) || /cap[i√≠]t/i.test(superS)) superS = "Nuevos Episodios";
      else superS = (m.type==="series") ? "Nuevas Series" : "Nuevas Peliculas";

      const sec = (m.section || "Novedades").trim() || "Novedades";

      if(!out.has(date)) out.set(date, new Map());
      const ssMap = out.get(date);

      if(!ssMap.has(superS)) ssMap.set(superS, new Map());
      const secMap = ssMap.get(superS);

      if(!secMap.has(sec)) secMap.set(sec, {sec, items:[]});
      secMap.get(sec).items.push(it);
    }

    // Convierte los mapas internos a arrays (preservan orden de inserci√≥n)
    for(const [date, ssMap] of out.entries()){
      for(const [ss, secMap] of ssMap.entries()){
        ssMap.set(ss, [...secMap.values()]);
      }
    }
    return out;
  }


  function fmtTimeTriplet(iso){
    try{
      const d = new Date(iso);
      if(isNaN(d.getTime())) return null;

      const opts = {hour:"numeric", minute:"2-digit"};
      const et = new Intl.DateTimeFormat("es-MX", {...opts, timeZone:"America/New_York"}).format(d);
      const ct = new Intl.DateTimeFormat("es-MX", {...opts, timeZone:"America/Chicago"}).format(d);
      const pt = new Intl.DateTimeFormat("es-MX", {...opts, timeZone:"America/Los_Angeles"}).format(d);

      // Normalizamos a AM/PM estilo manual (muchos navegadores ya lo devuelven as√≠ en es-MX)
      return `${et} Este, ${ct} Centro, ${pt} Pac√≠fico`;
    }catch(e){ return null; }
  }

  function canUseIcs(m, mins){
    if(!m || !m.start_utc) return false;
    const start = new Date(m.start_utc);
    if(isNaN(start.getTime())) return false;
    const now = new Date();
    const diffMs = start.getTime() - now.getTime();
    if(diffMs <= 0) return false;
    if(diffMs < mins * 60 * 1000) return false;
    return true;
  }

  async function downloadIcs(itemId, mins){
    try{
      vibrate(12);
      const headers = {};
      if(API_KEY) headers["x-api-key"] = API_KEY;
      const url = `${API_BASE}/api/ics/${encodeURIComponent(itemId)}?mins=${mins}`;
      const r = await fetch(url, {headers});
      if(!r.ok) throw new Error("HTTP " + r.status);
      const blob = await r.blob();
      const a = document.createElement("a");
      const objectUrl = URL.createObjectURL(blob);
      a.href = objectUrl;
      a.download = `bcntv_${itemId}_${mins}m.ics`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(objectUrl), 1500);
    }catch(e){
      alert("No se pudo descargar el recordatorio (ICS).\n" + e.message);
    }
  }

  function sportEmoji(cat, raw){
    const c = safeLower(cat);
    const r = safeLower(raw);

    if(r.includes("nascar")) return "üèéÔ∏è";
    if(r.includes("rugby")) return "üèâ";
    if(r.includes("wrestling") || r.includes("aew") || r.includes("wwe")) return "ü§º‚Äç‚ôÇÔ∏è";

    if(c.includes("golf") || r.includes("pga") || r.includes("liv golf") || r.includes("ryder") || r.includes("masters")) return "‚õ≥";
    if(c.includes("grand") || r.includes("wimbledon") || r.includes("roland") || r.includes("australian open") || r.includes("us open") || r.includes("atp") || r.includes("wta")) return "üéæ";
    if(c.includes("softball") || c.includes("softbol") || r.includes("softball") || r.includes("softbol")) return "ü•é";
    if(c.includes("combate") || r.includes("ufc") || r.includes("box") || r.includes("boxeo") || r.includes("bellator")) return "ü•ä";
    return "‚öΩ";
  }

  
  function cleanMediaDateLabel(dl){
    dl = (dl||"").toString().trim();
    const m = dl.match(/(\d{4})\s*$/);
    if(!m) return dl;
    const y = parseInt(m[1],10);
    if(!Number.isFinite(y)) return "";
    return (y >= 2024) ? dl : "";
  }

function card(it){
    const m = it.meta || {};
    const isVipItem = !!m.is_vip;
    const locked = isVipItem && !VIP && (vipFilter.value === "show_locked");

    const iid = itemId(it);

    const imgInfo = resolveCardImage(it);
    if(imgInfo && imgInfo.needsFetch){
      queuePosterFetch(iid, imgInfo.titleClean, imgInfo.kind, imgInfo.cacheKey);
    }

    const favOn = isFav(iid);
    const favLabel = favOn ? "Quitar de favoritos" : "Agregar a favoritos";
    const favIcon = favOn ? "‚òÖ" : "‚òÜ";

    const type = m.type || "";

    // Pills principales
    const pills = [];
    if(type === "sport"){
      const emoji = sportEmoji(it.cat||"", m.raw||"");
      const comp = (m.competition || "Deportes");
      pills.push(`${emoji} ${comp}`);
      if(m.ronda) pills.push(String(m.ronda));
      if(m.jornada){
        const j = String(m.jornada);
        pills.push(safeLower(j).includes("jornada") ? j : `Jornada ${j}`);
      }
      if(m.is_live_now) pills.push("üî¥ En Vivo");
    }else{
      if(it.cat) pills.push(it.cat);
      if(m.super_section) pills.push(m.super_section);
      if(m.section) pills.push(m.section);
      if(m.se) pills.push(m.se);
      if(m.quality) pills.push(m.quality);
    }

    const canalesTxt = buildCanalesTxt(m, type);
    const timeTriplet = (type === "sport" && m.start_utc) ? fmtTimeTriplet(m.start_utc) : null;

    const ics5 = canUseIcs(m, 5);
    const ics10 = canUseIcs(m, 10);
    const ics15 = canUseIcs(m, 15);

    const flags = (Array.isArray(m.flags) && m.flags.length) ? m.flags.join(" ") : "";
    const dateLabel = cleanMediaDateLabel(m.date_label);

    return `
      <div class="card">
        ${posterHtml(iid, imgInfo)}
        <div class="meta">
          ${type === "sport" ? `<p class="t"><b><span class="megaphone">üì£Ô∏é</span> ${escapeHtml(it.t || "")}</b></p>` : `<p class="t">${escapeHtml(it.t || "")}</p>`}

          <div>
            ${pills.slice(0,4).map(x=>{
              const live = safeLower(x).includes("en vivo");
              return `<span class="pill ${live ? "live":""}">${escapeHtml(x)}</span>`;
            }).join("")}
          </div>

          ${type === "sport" ? `
            <div class="solid"></div>
            ${m.ronda ? `<div class="line">üóìÔ∏è <b>${escapeHtml(m.ronda)}</b></div>` : ``}
            ${m.jornada ? `<div class="line">üóìÔ∏è <b>${escapeHtml(m.jornada)}</b></div>` : ``}
            ${m.global ? `<div class="line">üß© <b>${escapeHtml(m.global)}</b></div>` : ``}
            ${m.sede ? `<div class="line">üìç ${escapeHtml(m.sede)}</div>` : ``}
            ${m.hora_text ? `<div class="line">üïí <b>Horario</b>: ${escapeHtml(m.hora_text)}</div>` : (timeTriplet ? `<div class="line">üïí <b>Horario</b>: ${escapeHtml(timeTriplet)}</div>` : (m.hora_original ? `<div class="line">üïí <b>Horario</b>: ${escapeHtml(m.hora_original + (m.timezone ? (" " + m.timezone) : ""))}</div>` : ``))}
            ${canalesTxt ? `<div class="line">üì∫: ${escapeHtml(canalesTxt)}</div>` : ``}
          ` : `
            ${flags ? `<div class="line">${escapeHtml(flags)}</div>` : ``}
            <div class="line">${escapeHtml(dateLabel ? ("üóìÔ∏è " + dateLabel) : "")}</div>
          `}
        </div>

        <div class="actions">
          <button class="btn ${favOn?"on":""}" data-fav="${escapeHtml(iid)}">${favIcon} ${favLabel}</button>
          ${type === "sport" ? `
            <button class="btn small ${ics5?"primary":"disabled"}" data-ics="${escapeHtml(iid)}" data-mins="5" ${ics5?"":"disabled"}>‚è∞ 5 min</button>
            <button class="btn small ${ics10?"primary":"disabled"}" data-ics="${escapeHtml(iid)}" data-mins="10" ${ics10?"":"disabled"}>‚è∞ 10 min</button>
            <button class="btn small ${ics15?"primary":"disabled"}" data-ics="${escapeHtml(iid)}" data-mins="15" ${ics15?"":"disabled"}>‚è∞ 15 min</button>
          ` : ``}
        </div>

        ${locked ? `
          <div class="lock">
            <div class="box">
              <h4>üîí Contenido VIP</h4>
              <p>Accede desde Telegram con permiso VIP (o activa VIP en ‚öôÔ∏è Config).</p>
            </div>
          </div>
        ` : ``}
      </div>
    `;
  }

  function render(){
    const arr = filterItems();

    if(!arr.length){
      grid.innerHTML = `<div class="section"><h2>Sin resultados <span class="sub">‚Äî revisa tu b√∫squeda o espera al sync</span></h2></div>`;
      bindActions();
      return;
    }

    // Deportes
    if(TAB === "sports"){
      const groups = groupSports(arr);
      let html = "";
      for(const [comp, items] of groups.entries()){
        html += `<div class="section"><h2>üèÜ ${escapeHtml(comp)}</h2></div>`;
        for(const it of items.slice(0,60)) html += card(it);
      }
      grid.innerHTML = html;
      bindActions();
      return;
    }

    // Movies/Series/All/Favs
    const vod = arr.filter(x => x.meta && (x.meta.type==="movie" || x.meta.type==="series"));
    const sports = arr.filter(x => x.meta && x.meta.type==="sport");

    let html = "";

    if((TAB === "all" || TAB === "favs") && sports.length){
      html += `<div class="section"><h2>Deportes <span class="sub">‚Äî filtrados</span></h2></div>`;
      const groups = groupSports(sports);
      for(const [comp, items] of groups.entries()){
        html += `<div class="section"><h2>üèÜ ${escapeHtml(comp)}</h2></div>`;
        for(const it of items.slice(0,30)) html += card(it);
      }
    }

    if(vod.length){
      // Si estamos en movies/series, filtramos por tipo aqu√≠ para mantener agrupaci√≥n uniforme
      const vod2 = (TAB==="movies") ? vod.filter(x=>x.meta.type==="movie") :
                   (TAB==="series") ? vod.filter(x=>x.meta.type==="series") : vod;

      const byDate = groupVOD(vod2);

      // Orden: fechas no vac√≠as primero, luego vac√≠o
            function dateSortKey(lbl){
        const up0 = (lbl||"").trim().toUpperCase();
        // Soporta: 18 DE FEBRERO DE 2026 | 18 DE FEBRERO DEL 2026 | MIERCOLES 18 DE FEBRERO DEL 2026 | FECHA: ...
        let up = up0.replace(/^\s*FECHA\s*:\s*/i, "").trim().replace(/\s{2,}/g, " ");

        // Quita d√≠a de semana si existe
        const dow = ["LUNES","MARTES","MIERCOLES","MI√âRCOLES","JUEVES","VIERNES","SABADO","S√ÅBADO","DOMINGO"];
        for(const d of dow){
          if(up.startsWith(d + " ")){
            up = up.slice(d.length).trim();
            break;
          }
        }
        // Quita basura al final (puntos, comas, etc.)
        up = up.replace(/[^0-9A-Z√Å√â√ç√ì√ö√ë\s]+$/g, "").trim().replace(/\s{2,}/g, " ");

        const m = up.match(/^(\d{1,2})\s+DE\s+([A-Z√Å√â√ç√ì√ö√ë]+)\s+(?:DE|DEL)\s+(\d{4})$/);
        if(!m) return [9999,99,99, up0];
        const dd = +m[1], mes = (m[2]||"").toUpperCase().replace("SETIEMBRE","SEPTIEMBRE"), yyyy = +m[3];
        const months = ["ENERO","FEBRERO","MARZO","ABRIL","MAYO","JUNIO","JULIO","AGOSTO","SEPTIEMBRE","OCTUBRE","NOVIEMBRE","DICIEMBRE"];
        const mm = months.indexOf(mes) >= 0 ? (months.indexOf(mes)+1) : 99;
        return [-yyyy,-mm,-dd, up0];
      }

const datesAll = [...byDate.keys()].sort((a,b)=>{
        if(!a && b) return 1;
        if(a && !b) return -1;
        const ka = dateSortKey(a);
        const kb = dateSortKey(b);
        for(let i=0;i<ka.length;i++){
          if(ka[i] < kb[i]) return -1;
          if(ka[i] > kb[i]) return 1;
        }
        return 0;
      });

      // Solo 2 fechas m√°s recientes (como en el bot)
      const dates = datesAll.filter(d=>d).slice(0,2);

      for(const date of dates){
        const ssMap = byDate.get(date);
        if(date){
          html += `<div class="section"><h2><span class="sub">üóìÔ∏è FECHA: ${escapeHtml(date.toUpperCase())}</span></h2></div>`;
        }

        // Orden sugerido
        const ssOrder = ["Nuevas Peliculas", "Nuevas Series", "Nuevos Episodios"];
        const ssKeys = [...ssMap.keys()];
        const ordered = [...new Set([...ssOrder, ...ssKeys])].filter(x=>ssMap.has(x));

        for(const ss of ordered){
          html += `<div class="section"><h2>üé• ${escapeHtml(ss.toUpperCase())}</h2></div>`;
          const blocks = ssMap.get(ss) || [];
          for(const block of blocks){
            const sec = (block && block.sec) ? block.sec : "Novedades";
            const items = (block && block.items) ? block.items : [];
            html += `<div class="section"><h2>‚ú® ${escapeHtml(sec)}<span class="sub">‚Ä¶</span></h2></div>`;
            for(const it of items.slice(0,60)) html += card(it);
          }
        }
      }
    }

    grid.innerHTML = html;
    bindActions();
  }

  function bindActions(){
    document.querySelectorAll("[data-fav]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-fav");
        if(id) toggleFav(id);
      });
    });
    document.querySelectorAll("[data-ics]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(btn.disabled) return;
        const id = btn.getAttribute("data-ics");
        const mins = parseInt(btn.getAttribute("data-mins")||"10", 10);
        if(id) downloadIcs(id, mins);
      });
    });
  }

  fetchData();
  setInterval(fetchData, 15 * 60 * 1000);
</script>
</body>
</html>
