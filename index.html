<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background: var(--tg-theme-bg-color, #0b0b0b); color: var(--tg-theme-text-color, #fff); font-family: sans-serif; text-align: center; }
        .btn { background: var(--tg-theme-button-color, #00ff88); color: var(--tg-theme-button-text-color, #000); padding: 16px; border-radius: 12px; width: 85%; border: none; font-weight: bold; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: wait; }
        
        /* Spinner para Cold Start */
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--tg-theme-button-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="main-ui">
        <h2 id="userName">Cargando datos...</h2>
        <div id="loader" class="spinner"></div>
        <button id="authBtn" class="btn" onclick="autorizar()">ACTIVAR PREMIUM</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const API_BASE = "https://tu-app-en-render.onrender.com"; 

        tg.ready();
        tg.expand();

        const user = tg.initDataUnsafe?.user;
        if (user) {
            document.getElementById("userName").innerText = `Hola, ${user.first_name}`;
        }

        async function autorizar() {
            const btn = document.getElementById('authBtn');
            const loader = document.getElementById('loader');
            
            btn.disabled = true;
            loader.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/api/autorizar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        uid: user.id.toString(),
                        initData: tg.initData 
                    })
                });

                if (response.ok) {
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showPopup({ title: "¡Éxito!", message: "Suscripción validada." });
                } else {
                    tg.showAlert("Firma de seguridad inválida.");
                }
            } catch (e) {
                tg.showAlert("El servidor está despertando. Reintenta en 10 segundos.");
            } finally {
                btn.disabled = false;
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>
