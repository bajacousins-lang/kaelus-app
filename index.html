<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BCNTV WebPremium</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#141420; --muted:#b7b7c6; --text:#fff;
      --line:#23233a; --pill:#1d1d2e; --accent:#ff3ea5;
      --good:#18d26b; --warn:#ffbf2f;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:rgba(11,11,15,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:5}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:#111;object-fit:cover;border:1px solid var(--line)}
    .title{font-weight:800;letter-spacing:.3px}
    .vip{font-size:12px;color:var(--muted)}
    .vip b{color:var(--good)}
    .bar{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    input[type="search"]{
      flex:1;min-width:220px;padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      background:#0f0f18;color:var(--text);outline:none
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:var(--pill);
      color:var(--text);cursor:pointer;font-weight:700;font-size:13px
    }
    .tab.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,62,165,.15) inset}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0f0f18;color:var(--text);
      outline:none
    }
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;padding:14px 0}
    .section{grid-column:1/-1;margin-top:10px}
    .section h2{margin:0 0 10px 0;font-size:15px;color:#f2f2ff;letter-spacing:.2px}
    .section h2 .sub{color:var(--muted);font-weight:600}
    .card{
      grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:18px;
      overflow:hidden;display:flex;gap:12px;padding:12px;
      position:relative; /* (a√±adido) para overlay lock */
    }
    @media(min-width:720px){ .card{grid-column:span 6} }
    @media(min-width:980px){ .card{grid-column:span 4} }
    .poster{width:86px;height:124px;border-radius:14px;border:1px solid var(--line);background:#0f0f18;object-fit:cover}
    .meta{flex:1;min-width:0}
    .t{font-weight:800;margin:0 0 6px 0;font-size:14px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;margin-right:6px;margin-bottom:6px}
    .line{color:var(--muted);font-size:12px;line-height:1.35}
    .actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .star{
      border:1px solid var(--line);background:#0f0f18;color:#fff;border-radius:12px;
      padding:9px 10px;cursor:pointer;font-weight:900
    }
    .star.on{border-color:var(--warn);box-shadow:0 0 0 2px rgba(255,191,47,.12) inset}
    .footer{padding:22px 0;color:var(--muted);font-size:12px;border-top:1px solid var(--line);margin-top:18px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:12px}
    .badge.good b{color:var(--good)}

    /* (a√±adido) overlay cuando el contenido es VIP y no tienes VIP */
    .lock{
      position:absolute;inset:0;background:rgba(0,0,0,.65);
      display:flex;align-items:center;justify-content:center;text-align:center;padding:14px;
    }
    .lock .box{
      max-width:260px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);border-radius:14px;padding:12px;
    }
    .lock .box h4{margin:0 0 6px 0;font-size:14px}
    .lock .box p{margin:0;color:#e8e8f2;font-size:12px;line-height:1.35}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img class="logo" id="logo" src="./logo.png" alt="logo" onerror="this.src='https://bajacousins-lang.github.io/kaelus-app/logo.png'"/>
        <div>
          <div class="title">BCNTV WebPremium</div>
          <div class="vip" id="vipLine">Estado: <b>VIP</b></div>
        </div>
      </div>

      <!-- (corregido/a√±adido) mantenemos tu badge y a√±adimos bot√≥n config sin borrar -->
      <div class="row">
        <div class="badge good" id="statusBadge">‚óè <span id="statusText">Conectando‚Ä¶</span></div>
        <button class="tab" id="btnConfig" type="button" title="Configurar API/VIP">‚öôÔ∏è Config</button>
      </div>
    </div>

    <div class="bar">
      <input id="q" type="search" placeholder="Buscar por t√≠tulo, canal, estadio, liga (LaLiga), etc‚Ä¶"/>
      <div class="tabs">
        <button class="tab active" data-tab="all">Todo</button>
        <button class="tab" data-tab="favs">Favs</button>
        <button class="tab" data-tab="sports">Deportes</button>
        <button class="tab" data-tab="movies">Pel√≠culas</button>
        <button class="tab" data-tab="series">Series</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <select id="sportsSub">
        <option value="">Subfiltro deportes: Todos</option>
        <option value="LaLiga">LaLiga</option>
        <option value="Liga MX">Liga MX</option>
        <option value="COMBATE">Combate</option>
        <option value="GRAND">Tenis/Grand Slams</option>
        <option value="GOLF">Golf</option>
      </select>

      <!-- (a√±adido) filtro VIP como en la versi√≥n mejorada (sin borrar nada) -->
      <select id="vipFilter">
        <option value="show_locked">VIP: mostrar (bloqueados si no tienes)</option>
        <option value="show">VIP: mostrar solo si tienes</option>
        <option value="hide">VIP: ocultar</option>
        <option value="only">VIP: solo VIP (si tienes)</option>
      </select>

      <div class="small">Auto-refresh cada 15 min ‚Ä¢ Favoritos guardados en tu dispositivo</div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="hint" id="apiHint"></div>
  <div class="grid" id="grid"></div>

  <div class="footer">
    <div>Si ves contenido fuera de lugar, es porque el scraper detect√≥ texto basura. El bot ya aplica limpieza (bad_phrases) y estructura por niveles.</div>
  </div>
</main>

<script>
  // ===== Config =====
  const params = new URLSearchParams(location.search);

  // (corregido) VIP persistente en localStorage + soporte ?vip=1 / ?vip=0
  let VIP = (function(){
    const v = (params.get("vip") || "").toLowerCase();
    if(v === "1" || v === "true") localStorage.setItem("BCNTV_VIP", "1");
    if(v === "0" || v === "false") localStorage.removeItem("BCNTV_VIP");
    return localStorage.getItem("BCNTV_VIP") === "1";
  })();

  const DEFAULT_API_BASE = "https://kaelus-bot.onrender.com";

  // (corregido) API base persistente + soporte ?api=...
  let API_BASE = (function(){
    const p = (params.get("api") || "").trim();
    if(p) localStorage.setItem("BCNTV_API_BASE", p);
    return (localStorage.getItem("BCNTV_API_BASE") || DEFAULT_API_BASE).replace(/\/$/,"");
  })();

  // (a√±adido) soporte API key (x-api-key) + ?key=...
  let API_KEY = (function(){
    const k = (params.get("key") || "").trim();
    if(k) localStorage.setItem("BCNTV_API_KEY", k);
    return (localStorage.getItem("BCNTV_API_KEY") || "").trim();
  })();

  let API_URL = API_BASE + "/api/links";

  // (corregido) reflejar VIP/API en UI (sin borrar tus l√≠neas, solo las hacemos din√°micas)
  function applyUiConfig(){
    document.getElementById("vipLine").innerHTML = "Estado: " + (VIP ? "<b>VIP</b>" : "<span style='color:#ff6b6b;font-weight:800'>No VIP</span>");
    const keyInfo = API_KEY ? " (key: s√≠)" : " (key: no)";
    document.getElementById("apiHint").textContent = "API: " + API_URL + keyInfo;
  }
  applyUiConfig();

  const grid = document.getElementById("grid");
  const q = document.getElementById("q");
  const sportsSub = document.getElementById("sportsSub");
  const vipFilter = document.getElementById("vipFilter");
  const tabs = [...document.querySelectorAll(".tab")];

  let TAB = "all";
  let DATA = [];
  let FAVS = loadFavs();

  function vibrate(ms=12){ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch(e){} }

  tabs.forEach(b=>{
    b.addEventListener("click", ()=>{
      vibrate(10);
      tabs.forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      TAB = b.dataset.tab;
      render();
    });
  });

  q.addEventListener("input", ()=> render());
  sportsSub.addEventListener("change", ()=> render());
  vipFilter.addEventListener("change", ()=> render());

  // (a√±adido) bot√≥n Config para cambiar API/VIP/KEY sin tocar tu estructura
  document.getElementById("btnConfig").addEventListener("click", ()=>{
    try{ vibrate(12); }catch(e){}

    const api = prompt("API Base URL (ej: https://kaelus-bot.onrender.com)", API_BASE);
    if(api !== null){
      const v = (api || "").trim();
      if(v) localStorage.setItem("BCNTV_API_BASE", v);
      API_BASE = (localStorage.getItem("BCNTV_API_BASE") || DEFAULT_API_BASE).replace(/\/$/,"");
      API_URL = API_BASE + "/api/links";
    }

    const key = prompt("API Key (x-api-key). Deja vac√≠o si no usas:", API_KEY);
    if(key !== null){
      const k = (key || "").trim();
      if(k) localStorage.setItem("BCNTV_API_KEY", k);
      else localStorage.removeItem("BCNTV_API_KEY");
      API_KEY = (localStorage.getItem("BCNTV_API_KEY") || "").trim();
    }

    const vip = confirm("¬øActivar VIP en este dispositivo?\nOK = VIP\nCancelar = No VIP");
    if(vip) localStorage.setItem("BCNTV_VIP","1"); else localStorage.removeItem("BCNTV_VIP");
    VIP = localStorage.getItem("BCNTV_VIP")==="1";

    applyUiConfig();
    fetchData();
  });

  function loadFavs(){
    try{
      return JSON.parse(localStorage.getItem("bcntv_favs")||"[]");
    }catch(e){ return []; }
  }
  function saveFavs(){
    localStorage.setItem("bcntv_favs", JSON.stringify(FAVS));
  }
  function isFav(id){ return FAVS.includes(id); }
  function toggleFav(id){
    vibrate(18);
    if(isFav(id)) FAVS = FAVS.filter(x=>x!==id);
    else FAVS.push(id);
    saveFavs();
    render();
  }

  function setStatus(ok, msg){
    const badge = document.getElementById("statusBadge");
    const text = document.getElementById("statusText");
    text.textContent = msg;
    badge.style.borderColor = ok ? "rgba(24,210,107,.5)" : "rgba(255,107,107,.5)";
  }

  async function fetchData(){
    try{
      setStatus(true, "Cargando‚Ä¶");

      // (a√±adido) headers con x-api-key si existe
      const headers = {};
      if(API_KEY) headers["x-api-key"] = API_KEY;

      const r = await fetch(API_URL, {cache:"no-store", headers});
      if(!r.ok) throw new Error("HTTP " + r.status);
      const j = await r.json();
      DATA = Array.isArray(j) ? j : [];

      // (a√±adido) cach√© local para modo offline
      try{
        localStorage.setItem("BCNTV_CACHE_ITEMS", JSON.stringify(DATA));
      }catch(e){}

      setStatus(true, "Online (" + DATA.length + ")");
      render();
    }catch(e){
      console.error(e);

      // (a√±adido) fallback a cach√© si existe
      const cached = localStorage.getItem("BCNTV_CACHE_ITEMS");
      if(cached){
        try{
          DATA = JSON.parse(cached) || [];
          setStatus(false, "Offline (cach√© " + DATA.length + ")");
          render();
          return;
        }catch(_){}
      }

      setStatus(false, "Offline");
      render();
    }
  }

  function textOfItem(it){
    const t = (it.t||"");
    const cat = (it.cat||"");
    const m = it.meta||{};
    return (t+" "+cat+" "+(m.canal||"")+" "+(m.sede||"")+" "+(m.competition||"")+" "+(m.jornada||"")+" "+(m.section||"")+" "+(m.date_label||"")).toLowerCase();
  }

  // (a√±adido) regla VIP, similar a la versi√≥n mejorada
  function allowByVip(it){
    const m = it.meta || {};
    const isVipItem = !!m.is_vip;
    const mode = vipFilter.value;

    if(mode === "show_locked"){
      // muestra todo; si es vip y no tienes, se ver√° bloqueado en la card()
      return true;
    }
    if(mode === "show"){
      if(!isVipItem) return true;
      return VIP;
    }
    if(mode === "hide"){
      return !isVipItem;
    }
    if(mode === "only"){
      return isVipItem && VIP;
    }
    return true;
  }

  function filterItems(){
    const term = (q.value||"").trim().toLowerCase();
    let arr = DATA.slice();

    // (a√±adido) VIP gate/filtro
    arr = arr.filter(allowByVip);

    // Tab filter
    if(TAB === "sports"){
      arr = arr.filter(x => (x.meta && x.meta.type === "sport") || (x.cat||"").includes("DEPORT") || (x.cat||"").includes("LaLiga") || (x.cat||"").includes("Liga MX"));
      const sub = sportsSub.value;
      if(sub){
        if(sub === "COMBATE") arr = arr.filter(x => (x.cat||"").includes("COMBATE"));
        else if(sub === "GRAND") arr = arr.filter(x => (x.cat||"").includes("GRAND"));
        else if(sub === "GOLF") arr = arr.filter(x => (x.cat||"").includes("GOLF"));
        else arr = arr.filter(x => (x.meta && x.meta.competition === sub) || (x.cat||"").includes(sub));
      }
    }
    if(TAB === "movies"){
      arr = arr.filter(x => (x.meta && x.meta.type === "movie") || (x.cat||"").includes("PEL"));
    }
    if(TAB === "series"){
      arr = arr.filter(x => (x.meta && x.meta.type === "series") || (x.cat||"").includes("SERIES"));
    }
    if(TAB === "favs"){
      arr = arr.filter(x => isFav(x._id));
    }

    // Search
    if(term){
      arr = arr.filter(x => textOfItem(x).includes(term));
    }

    return arr;
  }

  function groupSports(arr){
    const groups = new Map();
    for(const it of arr){
      const m = it.meta||{};
      const comp = m.competition || "Deportes";
      const j = m.jornada ? ("Jornada " + m.jornada) : "";
      const key = (comp + (j ? (" ‚Ä¢ " + j) : "")).trim();
      if(!groups.has(key)) groups.set(key, []);
      groups.get(key).push(it);
    }
    return groups;
  }

  function groupVOD(arr){
    // bucket -> section -> date_label -> items
    const out = new Map();
    for(const it of arr){
      const m = it.meta||{};
      const bucket = (m.bucket||((m.type==="series")?"Series":"Peliculas")) || "Contenido";
      const section = m.section || "Novedades";
      const date = m.date_label || "";
      const k1 = bucket;
      if(!out.has(k1)) out.set(k1, new Map());
      const secMap = out.get(k1);
      if(!secMap.has(section)) secMap.set(section, new Map());
      const dateMap = secMap.get(section);
      if(!dateMap.has(date)) dateMap.set(date, []);
      dateMap.get(date).push(it);
    }
    return out;
  }

  function card(it){
    const m = it.meta || {};
    const pills = [];
    if(it.cat) pills.push(it.cat);
    if(m.section) pills.push(m.section);
    if(m.se) pills.push(m.se);
    if(m.quality) pills.push(m.quality);
    if(Array.isArray(m.flags) && m.flags.length) pills.push(m.flags.join(" "));
    if(m.canal) pills.push("üì∫ " + m.canal);
    if(m.hora_original) pills.push("‚è∞ " + m.hora_original + (m.timezone ? (" " + m.timezone) : ""));
    if(m.sede) pills.push("üèüÔ∏è " + m.sede);

    const favOn = isFav(it._id);

    // (a√±adido) overlay lock si es VIP y no tienes VIP (solo se ver√° cuando vipFilter=show_locked)
    const isVipItem = !!m.is_vip;
    const locked = isVipItem && !VIP && (vipFilter.value === "show_locked");

    return `
      <div class="card">
        <img class="poster" loading="lazy" src="${it.img || "./logo.png"}" alt="img"
             onerror="this.src='./logo.png'"/>
        <div class="meta">
          <p class="t">${escapeHtml(it.t || "")}</p>
          <div>
            ${pills.slice(0,4).map(x=>`<span class="pill">${escapeHtml(x)}</span>`).join("")}
          </div>
          <div class="line">
            ${m.type === "sport"
              ? escapeHtml(((m.competition||"") + (m.jornada?(" ‚Ä¢ Jornada "+m.jornada):"")).trim())
              : escapeHtml((m.bucket||"") + (m.date_label?(" ‚Ä¢ "+m.date_label):""))
            }
          </div>
        </div>
        <div class="actions">
          <button class="star ${favOn?"on":""}" data-fav="${it._id}">${favOn?"‚òÖ":"‚òÜ"}</button>
        </div>

        ${locked ? `
          <div class="lock">
            <div class="box">
              <h4>üîí Contenido VIP</h4>
              <p>Accede desde Telegram con permiso VIP (o activa VIP en ‚öôÔ∏è Config).</p>
            </div>
          </div>
        ` : ``}
      </div>
    `;
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function render(){
    const arr = filterItems();

    // Empty
    if(!arr.length){
      grid.innerHTML = `<div class="section"><h2>Sin resultados <span class="sub">‚Äî revisa tu b√∫squeda o espera al sync</span></h2></div>`;
      bindStars();
      return;
    }

    // Deportes agrupados
    if(TAB === "sports"){
      const groups = groupSports(arr);
      let html = "";
      for(const [k, items] of groups.entries()){
        html += `<div class="section"><h2>${escapeHtml(k)}</h2></div>`;
        for(const it of items.slice(0,60)){
          html += card(it);
        }
      }
      grid.innerHTML = html;
      bindStars();
      return;
    }

    // Pelis/series agrupadas (bucket->section->date)
    if(TAB === "movies" || TAB === "series" || TAB === "all" || TAB === "favs"){
      const vod = arr.filter(x => (x.meta && (x.meta.type==="movie" || x.meta.type==="series")) || (x.cat||"").includes("PEL") || (x.cat||"").includes("SERIES"));
      const sports = arr.filter(x => x.meta && x.meta.type==="sport");

      let html = "";

      // Si estamos en ALL o FAVS, primero deportes, luego VOD
      if((TAB === "all" || TAB === "favs") && sports.length){
        html += `<div class="section"><h2>Deportes <span class="sub">‚Äî filtrados</span></h2></div>`;
        const groups = groupSports(sports);
        for(const [k, items] of groups.entries()){
          html += `<div class="section"><h2>${escapeHtml(k)}</h2></div>`;
          for(const it of items.slice(0,30)) html += card(it);
        }
      }

      if(vod.length){
        const g = groupVOD(vod);
        for(const [bucket, secMap] of g.entries()){
          html += `<div class="section"><h2>${escapeHtml(bucket)}</h2></div>`;
          for(const [section, dateMap] of secMap.entries()){
            html += `<div class="section"><h2>üìå ${escapeHtml(section)}</h2></div>`;
            for(const [date, items] of dateMap.entries()){
              if(date){
                html += `<div class="section"><h2><span class="sub">${escapeHtml(date)}</span></h2></div>`;
              }
              for(const it of items.slice(0,60)){
                html += card(it);
              }
            }
          }
        }
      }

      grid.innerHTML = html;
      bindStars();
      return;
    }

    // fallback
    grid.innerHTML = arr.map(card).join("");
    bindStars();
  }

  function bindStars(){
    document.querySelectorAll("[data-fav]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        toggleFav(btn.getAttribute("data-fav"));
      });
    });
  }

  // Auto refresh 15 min
  fetchData();
  setInterval(fetchData, 15 * 60 * 1000);
</script>
</body>
</html>
