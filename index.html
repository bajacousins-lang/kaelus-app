<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BCNTV WebPremium</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#141420; --muted:#b7b7c6; --text:#fff;
      --line:#23233a; --pill:#1d1d2e; --accent:#ff3ea5;
      --good:#18d26b; --warn:#ffbf2f; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:rgba(11,11,15,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:5}
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .top{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:34px;height:34px;border-radius:10px;background:#111;object-fit:cover;border:1px solid var(--line)}
    .title{font-weight:800;letter-spacing:.3px}
    .vip{font-size:12px;color:var(--muted)}
    .vip b{color:var(--good)}
    .bar{display:flex;gap:10px;align-items:center;margin-top:10px;flex-wrap:wrap}
    input[type="search"]{
      flex:1;min-width:220px;padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      background:#0f0f18;color:var(--text);outline:none
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);background:var(--pill);
      color:var(--text);cursor:pointer;font-weight:800;font-size:13px
    }
    .tab.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(255,62,165,.15) inset}
    .small{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    select{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#0f0f18;color:var(--text);
      outline:none
    }
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;padding:14px 0}
    .section{grid-column:1/-1;margin-top:10px}
    .section h2{margin:0 0 10px 0;font-size:15px;color:#f2f2ff;letter-spacing:.2px}
    .section h2 .sub{color:var(--muted);font-weight:650}
    .card{
      grid-column:span 12;background:var(--card);border:1px solid var(--line);border-radius:18px;
      overflow:hidden;display:flex;gap:12px;padding:12px;
      position:relative;
    }
    @media(min-width:720px){ .card{grid-column:span 6} }
    @media(min-width:980px){ .card{grid-column:span 4} }

    .poster{width:86px;height:124px;border-radius:14px;border:1px solid var(--line);background:#0f0f18;object-fit:cover}
    .meta{flex:1;min-width:0}
    .t{font-weight:900;margin:0 0 6px 0;font-size:14px}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px;margin-right:6px;margin-bottom:6px}
    .pill.live{border-color:rgba(24,210,107,.5);color:#eafff3}
    .pill.warn{border-color:rgba(255,191,47,.55);color:#fff6d8}
    .line{color:var(--muted);font-size:12px;line-height:1.35;word-break:break-word}
    .solid{height:1px;background:rgba(255,255,255,.15);margin:6px 0 8px 0}
    .light{height:1px;background:rgba(255,255,255,.08);margin:8px 0}
    .actions{display:flex;gap:8px;align-items:flex-end;justify-content:flex-end;flex-direction:column}
    .btn{
      border:1px solid var(--line);background:#0f0f18;color:#fff;border-radius:12px;
      padding:9px 10px;cursor:pointer;font-weight:900;font-size:12px;white-space:nowrap
    }
    .btn.small{padding:7px 9px;font-size:12px}
    .btn.on{border-color:var(--warn);box-shadow:0 0 0 2px rgba(255,191,47,.12) inset}
    .btn.disabled{opacity:.45;cursor:not-allowed}
    .btn.primary{border-color:rgba(255,62,165,.65);box-shadow:0 0 0 2px rgba(255,62,165,.12) inset}
    .footer{padding:22px 0;color:var(--muted);font-size:12px;border-top:1px solid var(--line);margin-top:18px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.03);font-size:12px}
    .badge.good b{color:var(--good)}

    .lock{
      position:absolute;inset:0;background:rgba(0,0,0,.65);
      display:flex;align-items:center;justify-content:center;text-align:center;padding:14px;
    }
    .lock .box{
      max-width:270px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);border-radius:14px;padding:12px;
    }
    .lock .box h4{margin:0 0 6px 0;font-size:14px}
    .lock .box p{margin:0;color:#e8e8f2;font-size:12px;line-height:1.35}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <img class="logo" id="logo" src="./logo.png" alt="logo"
             onerror="this.src='https://bajacousins-lang.github.io/kaelus-app/logo.png'"/>
        <div>
          <div class="title">BCNTV WebPremium</div>
          <div class="vip" id="vipLine">Estado: <b>VIP</b></div>
        </div>
      </div>

      <div class="row">
        <div class="badge good" id="statusBadge">‚óè <span id="statusText">Conectando‚Ä¶</span></div>
        <button class="tab" id="btnConfig" type="button" title="Configurar API/VIP">‚öôÔ∏è Config</button>
      </div>
    </div>

    <div class="bar">
      <input id="q" type="search" placeholder="Buscar por t√≠tulo, canal, estadio, liga (LaLiga), etc‚Ä¶"/>
      <div class="tabs">
        <button class="tab active" data-tab="all">Todo</button>
        <button class="tab" data-tab="favs">Favoritos</button>
        <button class="tab" data-tab="sports">Deportes</button>
        <button class="tab" data-tab="movies">Pel√≠culas</button>
        <button class="tab" data-tab="series">Series</button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <select id="sportsSub">
        <option value="">Subfiltro deportes: Todos</option>
        <option value="LaLiga">LaLiga</option>
        <option value="Liga MX">Liga MX</option>
        <option value="COMBATE">Combate</option>
        <option value="GRAND">Tenis/Grand Slams</option>
        <option value="GOLF">Golf</option>
      </select>

      <select id="vipFilter">
        <option value="show_locked">VIP: mostrar (bloqueados si no tienes)</option>
        <option value="show">VIP: mostrar solo si tienes</option>
        <option value="hide">VIP: ocultar</option>
        <option value="only">VIP: solo VIP (si tienes)</option>
      </select>

      <div class="small">Auto-refresh cada 15 min ‚Ä¢ Favoritos guardados en tu dispositivo</div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="hint" id="apiHint"></div>
  <div class="grid" id="grid"></div>

  <div class="footer">
    <div>Tips: En deportes puedes descargar recordatorios (ICS) a 5/10/15 min antes. Si el evento ya inici√≥, esos botones se desactivan.</div>
  </div>
</main>

<script>
  // ===== Config =====
  const params = new URLSearchParams(location.search);

  // VIP persistente: ?vip=1 / ?vip=0
  let VIP = (function(){
    const v = (params.get("vip") || "").toLowerCase();
    if(v === "1" || v === "true") localStorage.setItem("BCNTV_VIP", "1");
    if(v === "0" || v === "false") localStorage.removeItem("BCNTV_VIP");
    return localStorage.getItem("BCNTV_VIP") === "1";
  })();

  // Backend por defecto (Render). Para GitHub Pages, normalmente no se toca.
  const DEFAULT_API_BASE = "https://kaelus-bot.onrender.com";

  // API base persistente + soporte ?api=...
  let API_BASE = (function(){
    const p = (params.get("api") || "").trim();
    if(p) localStorage.setItem("BCNTV_API_BASE", p);
    return (localStorage.getItem("BCNTV_API_BASE") || DEFAULT_API_BASE).replace(/\/$/,"");
  })();

  // API key opcional (x-api-key) + ?key=...
  let API_KEY = (function(){
    const k = (params.get("key") || "").trim();
    if(k) localStorage.setItem("BCNTV_API_KEY", k);
    return (localStorage.getItem("BCNTV_API_KEY") || "").trim();
  })();

  let API_URL = API_BASE + "/api/links";

  function applyUiConfig(){
    document.getElementById("vipLine").innerHTML = "Estado: " + (VIP ? "<b>VIP</b>" : "<span style='color:var(--bad);font-weight:900'>No VIP</span>");
    const keyInfo = API_KEY ? " (key: s√≠)" : " (key: no)";
    document.getElementById("apiHint").textContent = "API: " + API_URL + keyInfo;
  }
  applyUiConfig();

  const grid = document.getElementById("grid");
  const q = document.getElementById("q");
  const sportsSub = document.getElementById("sportsSub");
  const vipFilter = document.getElementById("vipFilter");
  const tabs = [...document.querySelectorAll(".tab")];

  let TAB = "all";
  let DATA = [];
  let FAVS = loadFavs();

  function vibrate(ms=12){ try{ if(navigator.vibrate) navigator.vibrate(ms);}catch(e){} }

  tabs.forEach(b=>{
    b.addEventListener("click", ()=>{
      vibrate(10);
      tabs.forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      TAB = b.dataset.tab;
      render();
    });
  });

  q.addEventListener("input", ()=> render());
  sportsSub.addEventListener("change", ()=> render());
  vipFilter.addEventListener("change", ()=> render());

  document.getElementById("btnConfig").addEventListener("click", ()=>{
    try{ vibrate(12); }catch(e){}
    const api = prompt("API Base URL (ej: https://kaelus-bot.onrender.com)", API_BASE);
    if(api !== null){
      const v = (api || "").trim();
      if(v) localStorage.setItem("BCNTV_API_BASE", v);
      API_BASE = (localStorage.getItem("BCNTV_API_BASE") || DEFAULT_API_BASE).replace(/\/$/,"");
      API_URL = API_BASE + "/api/links";
    }

    const key = prompt("API Key (x-api-key). Deja vac√≠o si no usas:", API_KEY);
    if(key !== null){
      const k = (key || "").trim();
      if(k) localStorage.setItem("BCNTV_API_KEY", k);
      else localStorage.removeItem("BCNTV_API_KEY");
      API_KEY = (localStorage.getItem("BCNTV_API_KEY") || "").trim();
    }

    const vip = confirm("¬øActivar VIP en este dispositivo?\nOK = VIP\nCancelar = No VIP");
    if(vip) localStorage.setItem("BCNTV_VIP","1"); else localStorage.removeItem("BCNTV_VIP");
    VIP = localStorage.getItem("BCNTV_VIP")==="1";

    applyUiConfig();
    fetchData();
  });

  function loadFavs(){
    try{ return JSON.parse(localStorage.getItem("bcntv_favs")||"[]"); }
    catch(e){ return []; }
  }
  function saveFavs(){ localStorage.setItem("bcntv_favs", JSON.stringify(FAVS)); }
  function isFav(id){ return FAVS.includes(id); }
  function toggleFav(id){
    vibrate(18);
    if(isFav(id)) FAVS = FAVS.filter(x=>x!==id);
    else FAVS.push(id);
    saveFavs();
    render();
  }

  function setStatus(ok, msg){
    const badge = document.getElementById("statusBadge");
    const text = document.getElementById("statusText");
    text.textContent = msg;
    badge.style.borderColor = ok ? "rgba(24,210,107,.5)" : "rgba(255,107,107,.5)";
  }

  async function fetchData(){
    try{
      setStatus(true, "Cargando‚Ä¶");
      const headers = {};
      if(API_KEY) headers["x-api-key"] = API_KEY;

      const r = await fetch(API_URL, {cache:"no-store", headers});
      if(!r.ok) throw new Error("HTTP " + r.status);
      const j = await r.json();
      DATA = Array.isArray(j) ? j : [];

      try{ localStorage.setItem("BCNTV_CACHE_ITEMS", JSON.stringify(DATA)); }catch(e){}
      setStatus(true, "Online (" + DATA.length + ")");
      render();
    }catch(e){
      console.error(e);
      const cached = localStorage.getItem("BCNTV_CACHE_ITEMS");
      if(cached){
        try{
          DATA = JSON.parse(cached) || [];
          setStatus(false, "Offline (cach√© " + DATA.length + ")");
          render();
          return;
        }catch(_){}
      }
      setStatus(false, "Offline");
      render();
    }
  }

  function escapeHtml(s){
    return (s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
  }

  function safeLower(s){ return (s||"").toLowerCase(); }

  function textOfItem(it){
    const t = (it.t||"");
    const cat = (it.cat||"");
    const m = it.meta||{};
    const canales = Array.isArray(m.canales) ? m.canales.join(" ") : (m.canal||"");
    return (t+" "+cat+" "+canales+" "+(m.sede||"")+" "+(m.competition||"")+" "+(m.jornada||"")+" "+(m.section||"")+" "+(m.super_section||"")+" "+(m.date_label||"")).toLowerCase();
  }

  function allowByVip(it){
    const m = it.meta || {};
    const isVipItem = !!m.is_vip;
    const mode = vipFilter.value;

    if(mode === "show_locked") return true;
    if(mode === "show") return !isVipItem || VIP;
    if(mode === "hide") return !isVipItem;
    if(mode === "only") return isVipItem && VIP;
    return true;
  }

  function filterItems(){
    const term = (q.value||"").trim().toLowerCase();
    let arr = DATA.slice();

    arr = arr.filter(allowByVip);

    if(TAB === "sports"){
      arr = arr.filter(x => (x.meta && x.meta.type === "sport") || (x.cat||"").includes("DEPORT") || (x.cat||"").includes("LaLiga") || (x.cat||"").includes("Liga MX"));
      const sub = sportsSub.value;
      if(sub){
        if(sub === "COMBATE") arr = arr.filter(x => (x.cat||"").includes("COMBATE"));
        else if(sub === "GRAND") arr = arr.filter(x => (x.cat||"").includes("GRAND"));
        else if(sub === "GOLF") arr = arr.filter(x => (x.cat||"").includes("GOLF"));
        else arr = arr.filter(x => (x.meta && x.meta.competition === sub) || (x.cat||"").includes(sub));
      }
    }
    if(TAB === "movies"){
      arr = arr.filter(x => (x.meta && x.meta.type === "movie") || (x.cat||"").includes("PEL"));
    }
    if(TAB === "series"){
      arr = arr.filter(x => (x.meta && x.meta.type === "series") || (x.cat||"").includes("SERIES"));
    }
    if(TAB === "favs"){
      arr = arr.filter(x => isFav(itemId(x)));
    }

    if(term) arr = arr.filter(x => textOfItem(x).includes(term));
    return arr;
  }

  function groupSports(arr){
    const groups = new Map();
    for(const it of arr){
      const m = it.meta||{};
      const comp = m.competition || "Deportes";
      if(!groups.has(comp)) groups.set(comp, []);
      groups.get(comp).push(it);
    }
    return groups;
  }

  // VOD: date -> super_section -> section
  function groupVOD(arr){
    const out = new Map();
    for(const it of arr){
      const m = it.meta||{};
      const date = (m.date_label || "").trim();
      const superS = (m.super_section || (m.type==="series" ? "Nuevas Series" : "Nuevas Peliculas")).trim();
      const sec = (m.section || "Novedades").trim();

      if(!out.has(date)) out.set(date, new Map());
      const ssMap = out.get(date);
      if(!ssMap.has(superS)) ssMap.set(superS, new Map());
      const secMap = ssMap.get(superS);
      if(!secMap.has(sec)) secMap.set(sec, []);
      secMap.get(sec).push(it);
    }
    return out;
  }

  function fmtTimeTriplet(iso){
    try{
      const d = new Date(iso);
      if(isNaN(d.getTime())) return null;

      const opts = {hour:"numeric", minute:"2-digit"};
      const et = new Intl.DateTimeFormat("es-MX", {...opts, timeZone:"America/New_York"}).format(d);
      const ct = new Intl.DateTimeFormat("es-MX", {...opts, timeZone:"America/Chicago"}).format(d);
      const pt = new Intl.DateTimeFormat("es-MX", {...opts, timeZone:"America/Los_Angeles"}).format(d);

      // Normalizamos a AM/PM estilo manual (muchos navegadores ya lo devuelven as√≠ en es-MX)
      return `${et} Este, ${ct} Centro, ${pt} Pac√≠fico`;
    }catch(e){ return null; }
  }

  function canUseIcs(m, mins){
    if(!m || !m.start_utc) return false;
    const start = new Date(m.start_utc);
    if(isNaN(start.getTime())) return false;
    const now = new Date();
    const diffMs = start.getTime() - now.getTime();
    if(diffMs <= 0) return false;
    if(diffMs < mins * 60 * 1000) return false;
    return true;
  }

  async function downloadIcs(itemId, mins){
    try{
      vibrate(12);
      const headers = {};
      if(API_KEY) headers["x-api-key"] = API_KEY;
      const url = `${API_BASE}/api/ics/${encodeURIComponent(itemId)}?mins=${mins}`;
      const r = await fetch(url, {headers});
      if(!r.ok) throw new Error("HTTP " + r.status);
      const blob = await r.blob();
      const a = document.createElement("a");
      const objectUrl = URL.createObjectURL(blob);
      a.href = objectUrl;
      a.download = `bcntv_${itemId}_${mins}m.ics`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(objectUrl), 1500);
    }catch(e){
      alert("No se pudo descargar el recordatorio (ICS).\n" + e.message);
    }
  }

  function sportEmoji(cat, raw){
    const c = safeLower(cat);
    const r = safeLower(raw);
    if(c.includes("golf") || r.includes("pga") || r.includes("liv golf") || r.includes("ryder") || r.includes("masters")) return "‚õ≥";
    if(c.includes("grand") || r.includes("wimbledon") || r.includes("roland") || r.includes("australian open") || r.includes("us open") || r.includes("atp") || r.includes("wta")) return "üéæ";
        if(c.includes("softball") || c.includes("softbol") || r.includes("softball") || r.includes("softbol")) return "ü•é";
if(c.includes("combate") || r.includes("ufc") || r.includes("wwe") || r.includes("box") || r.includes("boxeo") || r.includes("bellator")) return "ü•ä";
    return "‚öΩ";
  }

  function card(it){
    const m = it.meta || {};
    const isVipItem = !!m.is_vip;
    const locked = isVipItem && !VIP && (vipFilter.value === "show_locked");

    const iid = itemId(it);

    const favOn = isFav(iid);
    const favLabel = favOn ? "Quitar de favoritos" : "Agregar a favoritos";
    const favIcon = favOn ? "‚òÖ" : "‚òÜ";

    const type = m.type || "";

    // Pills principales
    const pills = [];
    if(type === "sport"){
      const emoji = sportEmoji(it.cat||"", m.raw||"");
      const comp = (m.competition || "Deportes");
      pills.push(`${emoji} ${comp}`);
      if(m.ronda) pills.push(String(m.ronda));
      if(m.jornada){
        const j = String(m.jornada);
        pills.push(safeLower(j).includes("jornada") ? j : `Jornada ${j}`);
      }
      if(m.is_live_now) pills.push("üî¥ En Vivo");
    }else{
      if(it.cat) pills.push(it.cat);
      if(m.super_section) pills.push(m.super_section);
      if(m.section) pills.push(m.section);
      if(m.se) pills.push(m.se);
      if(m.quality) pills.push(m.quality);
    }

    const canales = Array.isArray(m.canales) ? m.canales : (m.canal ? [m.canal] : []);
    let canalesTxt = canales.length ? canales.join(", ") : "";
    if(type === "sport" && m.categoria){
      const cat = String(m.categoria);
      canalesTxt = canalesTxt ? (canalesTxt + ` y Categor√≠a ${cat}`) : (`Categor√≠a ${cat}`);
    }
    const timeTriplet = (type === "sport" && m.start_utc) ? fmtTimeTriplet(m.start_utc) : null;

    const ics5 = canUseIcs(m, 5);
    const ics10 = canUseIcs(m, 10);
    const ics15 = canUseIcs(m, 15);

    const flags = (Array.isArray(m.flags) && m.flags.length) ? m.flags.join(" ") : "";

    return `
      <div class="card">
        <img class="poster" loading="lazy" src="${escapeHtml(it.img || "./logo.png")}" alt="img" onerror="this.src='./logo.png'"/>
        <div class="meta">
          ${type === "sport" ? `<p class="t"><b>${escapeHtml(it.t || "")}</b></p>` : `<p class="t">${escapeHtml(it.t || "")}</p>`}

          <div>
            ${pills.slice(0,4).map(x=>{
              const live = safeLower(x).includes("en vivo");
              return `<span class="pill ${live ? "live":""}">${escapeHtml(x)}</span>`;
            }).join("")}
          </div>

          ${type === "sport" ? `
            <div class="solid"></div>
            ${m.ronda ? `<div class="line">üóìÔ∏è <b>${escapeHtml(m.ronda)}</b></div>` : ``}
            ${m.jornada ? `<div class="line">üóìÔ∏è <b>${escapeHtml(m.jornada)}</b></div>` : ``}
            ${m.global ? `<div class="line">üß© <b>${escapeHtml(m.global)}</b></div>` : ``}
            ${m.sede ? `<div class="line">üìç ${escapeHtml(m.sede)}</div>` : ``}
            ${m.hora_text ? `<div class="line">üïí <b>Horario</b>: ${escapeHtml(m.hora_text)}</div>` : (timeTriplet ? `<div class="line">üïí <b>Horario</b>: ${escapeHtml(timeTriplet)}</div>` : (m.hora_original ? `<div class="line">üïí <b>Horario</b>: ${escapeHtml(m.hora_original + (m.timezone ? (" " + m.timezone) : ""))}</div>` : ``))}
            ${canalesTxt ? `<div class="line">üì∫: ${escapeHtml(canalesTxt)}</div>` : ``}
          ` : `
            ${flags ? `<div class="line">${escapeHtml(flags)}</div>` : ``}
            <div class="line">${escapeHtml((m.date_label||"") ? ("üóìÔ∏è " + (m.date_label||"")) : "")}</div>
          `}
        </div>

        <div class="actions">
          <button class="btn ${favOn?"on":""}" data-fav="${escapeHtml(iid)}">${favIcon} ${favLabel}</button>
          ${type === "sport" ? `
            <button class="btn small ${ics5?"primary":"disabled"}" data-ics="${escapeHtml(iid)}" data-mins="5" ${ics5?"":"disabled"}>‚è∞ 5 min</button>
            <button class="btn small ${ics10?"primary":"disabled"}" data-ics="${escapeHtml(iid)}" data-mins="10" ${ics10?"":"disabled"}>‚è∞ 10 min</button>
            <button class="btn small ${ics15?"primary":"disabled"}" data-ics="${escapeHtml(iid)}" data-mins="15" ${ics15?"":"disabled"}>‚è∞ 15 min</button>
          ` : ``}
        </div>

        ${locked ? `
          <div class="lock">
            <div class="box">
              <h4>üîí Contenido VIP</h4>
              <p>Accede desde Telegram con permiso VIP (o activa VIP en ‚öôÔ∏è Config).</p>
            </div>
          </div>
        ` : ``}
      </div>
    `;
  }

  function render(){
    const arr = filterItems();

    if(!arr.length){
      grid.innerHTML = `<div class="section"><h2>Sin resultados <span class="sub">‚Äî revisa tu b√∫squeda o espera al sync</span></h2></div>`;
      bindActions();
      return;
    }

    // Deportes
    if(TAB === "sports"){
      const groups = groupSports(arr);
      let html = "";
      for(const [comp, items] of groups.entries()){
        html += `<div class="section"><h2>üèÜ ${escapeHtml(comp)}</h2></div>`;
        for(const it of items.slice(0,60)) html += card(it);
      }
      grid.innerHTML = html;
      bindActions();
      return;
    }

    // Movies/Series/All/Favs
    const vod = arr.filter(x => x.meta && (x.meta.type==="movie" || x.meta.type==="series"));
    const sports = arr.filter(x => x.meta && x.meta.type==="sport");

    let html = "";

    if((TAB === "all" || TAB === "favs") && sports.length){
      html += `<div class="section"><h2>Deportes <span class="sub">‚Äî filtrados</span></h2></div>`;
      const groups = groupSports(sports);
      for(const [comp, items] of groups.entries()){
        html += `<div class="section"><h2>üèÜ ${escapeHtml(comp)}</h2></div>`;
        for(const it of items.slice(0,30)) html += card(it);
      }
    }

    if(vod.length){
      // Si estamos en movies/series, filtramos por tipo aqu√≠ para mantener agrupaci√≥n uniforme
      const vod2 = (TAB==="movies") ? vod.filter(x=>x.meta.type==="movie") :
                   (TAB==="series") ? vod.filter(x=>x.meta.type==="series") : vod;

      const byDate = groupVOD(vod2);

      // Orden: fechas no vac√≠as primero, luego vac√≠o
      const dates = [...byDate.keys()].sort((a,b)=>{
        if(!a && b) return 1;
        if(a && !b) return -1;
        return 0;
      });

      for(const date of dates){
        const ssMap = byDate.get(date);
        if(date){
          html += `<div class="section"><h2><span class="sub">${escapeHtml(date.toUpperCase())}</span></h2></div>`;
        }

        // Orden sugerido
        const ssOrder = ["Nuevas Peliculas", "Nuevas Series", "Nuevos Episodios"];
        const ssKeys = [...ssMap.keys()];
        const ordered = [...new Set([...ssOrder, ...ssKeys])].filter(x=>ssMap.has(x));

        for(const ss of ordered){
          html += `<div class="section"><h2>üé• ${escapeHtml(ss.toUpperCase())}</h2></div>`;
          const secMap = ssMap.get(ss);
          for(const [sec, items] of secMap.entries()){
            html += `<div class="section"><h2>‚ú® ${escapeHtml(sec)}<span class="sub">‚Ä¶</span></h2></div>`;
            for(const it of items.slice(0,60)) html += card(it);
          }
        }
      }
    }

    grid.innerHTML = html;
    bindActions();
  }

  function bindActions(){
    document.querySelectorAll("[data-fav]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-fav");
        if(id) toggleFav(id);
      });
    });
    document.querySelectorAll("[data-ics]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(btn.disabled) return;
        const id = btn.getAttribute("data-ics");
        const mins = parseInt(btn.getAttribute("data-mins")||"10", 10);
        if(id) downloadIcs(id, mins);
      });
    });
  }

  fetchData();
  setInterval(fetchData, 15 * 60 * 1000);
</script>
</body>
</html>
