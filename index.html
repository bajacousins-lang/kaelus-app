<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>BCNTV Premium</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --accent: #00ff88; --bg: #000; --card: #121212; --muted:#9aa0a6; }
    body { background: var(--bg); color: #fff; font-family: -apple-system, system-ui, sans-serif; padding: 15px; margin: 0; }
    .search-box { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #1a1a1a; color: #fff; margin-bottom: 12px; box-sizing: border-box; outline: none; }
    .filter-bar { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 12px; scrollbar-width: none; position: sticky; top: 0; background: var(--bg); z-index: 10; }
    .pill { background: #222; border: 1px solid #333; color: #bbb; padding: 8px 14px; border-radius: 20px; white-space: nowrap; font-size: 12px; font-weight: 800; cursor: pointer; transition: .2s; user-select:none; }
    .pill.active { background: var(--accent); color: #000; border-color: var(--accent); }
    .card { background: var(--card); border-radius: 12px; padding: 12px; border: 1px solid #222; margin-bottom: 10px; display: flex; align-items: center; gap: 12px; }
    .logo-container { width: 55px; height: 75px; flex-shrink: 0; border-radius: 8px; border: 1px solid #333; overflow: hidden; background:#0b0b0b; }
    .logo-img { width: 100%; height: 100%; object-fit: cover; }
    .info { flex-grow: 1; min-width: 0; }
    .cat-tag { font-size: 9px; color: var(--accent); font-weight: 900; text-transform: uppercase; letter-spacing:.4px; }
    .title { font-weight: 800; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #eee; margin-top:2px; }
    .subtitle { font-size: 11px; color: var(--muted); margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .actions { display: flex; align-items: center; gap: 10px; }
    .btn-play { background: var(--accent); color: #000; border: none; padding: 8px 14px; border-radius: 8px; font-weight: 900; cursor: pointer; }
    .btn-fav { background: none; border: none; font-size: 20px; cursor: pointer; color: #444; padding:0 4px; }
    .btn-fav.active { color: #ffeb3b; }
    #loader { text-align: center; margin-top: 32vh; color: var(--accent); font-weight: 900; }
    #status { margin: 10px 0 12px; color: #ffc107; font-size: 12px; display: none; align-items: center; gap: 8px; }
    #status[data-level="2"] { color: #ff9800; }
    #status[data-level="3"] { color: #ff5252; }
    #status-message { flex: 1; }
    #status-close { background: none; border: none; color: inherit; font-size: 14px; cursor: pointer; }

    /* VIP overlay */
    #vip-lock { position: fixed; inset: 0; background: rgba(0,0,0,.92); display:none; align-items:center; justify-content:center; z-index: 999; padding: 22px; }
    .vip-card { width:100%; max-width:420px; background:#0f0f0f; border:1px solid #222; border-radius:16px; padding:18px; text-align:center; }
    .vip-card h2 { margin:0 0 10px; font-size:18px; }
    .vip-card p { margin:0 0 14px; color:#c7c7c7; font-size:13px; line-height:1.4; }
    .vip-card button { width:100%; padding:12px; border-radius:10px; border:0; background:var(--accent); color:#000; font-weight:900; cursor:pointer; }

    /* Modal */
    #modal { position: fixed; inset: 0; background: rgba(0,0,0,.75); display:none; align-items:flex-end; justify-content:center; z-index: 1000; }
    .modal-sheet { width:100%; max-width:560px; background:#0f0f0f; border:1px solid #222; border-radius:18px 18px 0 0; padding:14px; }
    .modal-head { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .modal-title { font-weight:900; font-size:14px; margin:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .modal-close { background:none; border:0; color:#fff; font-size:18px; cursor:pointer; }
    .modal-meta { margin-top:10px; font-size:12px; color:#d8d8d8; line-height:1.5; }
    .kv { color:#9aa0a6; }
    .divider { height:1px; background:#222; margin:10px 0; }
  </style>
</head>
<body>
  <div id="vip-lock">
    <div class="vip-card">
      <h2>üîí Zona VIP</h2>
      <p>Tu cuenta a√∫n no tiene acceso. Puedes solicitarlo aqu√≠ mismo y el administrador te aprueba con un bot√≥n.</p>
      <button id="btn-request-vip">Solicitar acceso</button>
    </div>
  </div>

  <input type="text" id="search" class="search-box" placeholder="üîç Buscar en BCNTV...">
  <div class="filter-bar" id="filter-bar"></div>

  <div id="status">
    <span id="status-message"></span>
    <button id="status-close" type="button" aria-label="Cerrar aviso">‚úï</button>
  </div>

  <div id="loader">üõ∞Ô∏è Conectando con Servidor...</div>
  <div id="container"></div>

  <!-- Modal INFO -->
  <div id="modal">
    <div class="modal-sheet">
      <div class="modal-head">
        <div style="min-width:0;">
          <div class="cat-tag" id="m-cat"></div>
          <div class="modal-title" id="m-title"></div>
        </div>
        <button class="modal-close" id="m-close">‚úï</button>
      </div>
      <div class="divider"></div>
      <div class="modal-meta" id="m-meta"></div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  const API_URL = window.API_URL || "https://kaelus-bot.onrender.com";

  let allItems = [];
  let currentFilter = 'TODOS';
  let currentSearch = '';
  let retryCount = 0;
  const maxRetries = 5;
  const baseRetryDelay = 2000;
  const fetchTimeoutMs = 12000;
  let initInProgress = false;

  let currentStatusMessage = '';
  let currentStatusLevel = 0;
  const loaderDefaultText = 'üõ∞Ô∏è Conectando con Servidor...';

  const FAVORITES_KEY = "bcntv_favs_v2"; // por _id
  const FAVORITES_OLD_KEY = "bcntv_favs"; // compat

  const FIXED_PILLS = [
    { label: 'üöÄ TODO', value: 'TODOS' },
    { label: '‚≠ê FAVS', value: '‚≠ê FAVORITOS' },
    { label: '‚öΩ DEPORTES', value: '‚öΩ DEPORTES' },
    { label: 'üé¨ PEL√çCULAS', value: 'üé¨ PEL√çCULAS' },
    { label: 'üì∫ SERIES', value: 'üì∫ SERIES' },
  ];

  function showError(message) {
    const loader = document.getElementById('loader');
    loader.textContent = message;
    loader.style.display = 'block';
    if (!allItems.length) document.getElementById('container').innerHTML = '';
    clearStatus();
  }

  function showStatus(message, level = 1, force = false) {
    const status = document.getElementById('status');
    const messageEl = document.getElementById('status-message');
    if (!message) { clearStatus(); return; }
    if (!force && currentStatusMessage && level < currentStatusLevel) return;
    messageEl.textContent = message;
    status.style.display = 'flex';
    status.dataset.level = String(level);
    currentStatusMessage = message;
    currentStatusLevel = level;
  }

  function clearStatus() {
    const status = document.getElementById('status');
    const messageEl = document.getElementById('status-message');
    messageEl.textContent = '';
    status.style.display = 'none';
    delete status.dataset.level;
    currentStatusMessage = '';
    currentStatusLevel = 0;
  }

  function escapeHtml(value) {
    return String(value ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function sanitizeUrl(url) {
    if (!url) return null;
    try {
      const parsed = new URL(String(url), window.location.href);
      if (parsed.protocol === 'http:' || parsed.protocol === 'https:') return parsed.href;
    } catch (e) { return null; }
    return null;
  }

  function normalizeCategory(cat) {
    if (!cat) return 'SIN CATEGOR√çA';
    return String(cat).trim();
  }

  function safeGetFavs() {
    // nuevo por _id
    try {
      const parsed = JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
      if (Array.isArray(parsed)) return parsed;
    } catch (e) {}
    return [];
  }

  function safeSetFavs(favs) {
    try { localStorage.setItem(FAVORITES_KEY, JSON.stringify(favs)); } catch (e) {}
  }

  function migrateOldFavsIfAny(items) {
    // si ten√≠an favoritos por URL vieja, los convertimos a _id cuando se pueda
    let old = [];
    try {
      old = JSON.parse(localStorage.getItem(FAVORITES_OLD_KEY) || '[]');
      if (!Array.isArray(old)) old = [];
    } catch (e) { old = []; }

    if (!old.length) return;

    const favs = new Set(safeGetFavs());
    const byU = new Map(items.map(it => [it.u, it._id]));
    old.forEach(u => {
      const id = byU.get(u);
      if (id) favs.add(id);
    });
    safeSetFavs(Array.from(favs));
    try { localStorage.removeItem(FAVORITES_OLD_KEY); } catch(e) {}
  }

  function normalizeItems(data) {
    if (!Array.isArray(data)) return null;
    const items = data
      .filter(it => it && (it.t || it.title) )
      .map(it => {
        const _id = String(it._id || it.id || '');
        const t = String(it.t || it.title || '').trim();
        const cat = normalizeCategory(it.cat);
        const img = sanitizeUrl(it.poster) || sanitizeUrl(it.img) || 'logo.png';
        const u = sanitizeUrl(it.u) || `${window.location.href}#item=${encodeURIComponent(_id || t)}`;
        const meta = (it.meta && typeof it.meta === 'object') ? it.meta : {};
        return { _id, t, cat, img, u, meta };
      })
      .filter(it => it.t.length > 0);

    return items;
  }

  function normalizeSearch(value) {
    return String(value ?? '')
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '')
      .toLowerCase();
  }

  function normalizeCategoryKey(value) {
    return normalizeSearch(value).replace(/\s+/g, ' ').trim();
  }

  async function checkVipGate() {
    const userId = tg?.initDataUnsafe?.user?.id;
    if (!userId) return true; // si no hay Telegram, deja ver (modo navegador)

    try {
      const res = await fetch(`${API_URL}/api/vip?id=${encodeURIComponent(userId)}`);
      const data = await res.json();
      const vip = !!data.vip;
      document.getElementById('vip-lock').style.display = vip ? 'none' : 'flex';
      return vip;
    } catch (e) {
      // si falla, no bloqueamos duro
      return true;
    }
  }

  async function init() {
    if (initInProgress) return;
    initInProgress = true;

    let timeoutId = null;
    try {
      const controller = new AbortController();
      timeoutId = setTimeout(() => controller.abort(), fetchTimeoutMs);

      const res = await fetch(`${API_URL}/api/links`, { signal: controller.signal });
      if (!res.ok) throw new Error(`Error ${res.status}`);

      const data = await res.json();
      const normalized = normalizeItems(data);
      if (normalized === null) throw new Error('Respuesta inv√°lida del servidor.');

      allItems = normalized;

      migrateOldFavsIfAny(allItems);

      buildFilters();
      render();

      const loader = document.getElementById('loader');
      loader.textContent = loaderDefaultText;
      loader.style.display = 'none';
      retryCount = 0;
      clearStatus();

      await checkVipGate();

    } catch (e) {
      retryCount += 1;
      if (retryCount > maxRetries) {
        showError('‚ùå No se pudo conectar. Verifica tu conexi√≥n y reintenta.');
        return;
      }
      showError(`‚ùå Error al conectar. Reintentando (${retryCount}/${maxRetries})...`);
      const delay = baseRetryDelay * retryCount;
      setTimeout(init, delay);
    } finally {
      if (timeoutId) clearTimeout(timeoutId);
      initInProgress = false;
    }
  }

  function buildFilters() {
    const filterBar = document.getElementById('filter-bar');
    filterBar.innerHTML = FIXED_PILLS.map(pill => `
      <div class="pill ${pill.value === currentFilter ? 'active' : ''}"
           onclick="filterData(${JSON.stringify(pill.value)}, this)">${escapeHtml(pill.label)}</div>
    `).join('');
  }

  function isSportsItem(it) {
    const type = String(it.meta?.type || '');
    return type === 'sport' || normalizeSearch(it.cat).includes('deport') || normalizeSearch(it.cat).includes('laliga') || normalizeSearch(it.cat).includes('liga mx');
  }

  function isMovieItem(it) {
    const type = String(it.meta?.type || '');
    return type === 'movie' || normalizeSearch(it.cat).includes('pel');
  }

  function isSeriesItem(it) {
    const type = String(it.meta?.type || '');
    return type === 'series' || normalizeSearch(it.cat).includes('series');
  }

  function render() {
    const container = document.getElementById('container');
    const favs = new Set(safeGetFavs());

    let filtered = allItems;

    // filtro principal
    if (currentFilter === '‚≠ê FAVORITOS') {
      filtered = filtered.filter(i => favs.has(i._id));
    } else if (currentFilter === '‚öΩ DEPORTES') {
      filtered = filtered.filter(isSportsItem);
    } else if (currentFilter === 'üé¨ PEL√çCULAS') {
      filtered = filtered.filter(isMovieItem);
    } else if (currentFilter === 'üì∫ SERIES') {
      filtered = filtered.filter(isSeriesItem);
    }

    // b√∫squeda inteligente: incluye meta
    if (currentSearch) {
      const q = normalizeSearch(currentSearch);
      filtered = filtered.filter(i => {
        const blob = [
          i.t, i.cat,
          i.meta?.competition, i.meta?.jornada, i.meta?.canal, i.meta?.venue,
          (i.meta?.flags || []).join(' '), i.meta?.quality, i.meta?.se,
          i.meta?.section, i.meta?.date_label
        ].filter(Boolean).join(' ');
        return normalizeSearch(blob).includes(q);
      });
    }

    if (filtered.length === 0) {
      container.innerHTML = `
        <div class="card">
          <div class="info">
            <div class="title">No hay resultados para mostrar.</div>
            <div class="subtitle">Intenta cambiar el filtro o buscar otra palabra.</div>
          </div>
        </div>`;
      return;
    }

    container.innerHTML = filtered.map(i => {
      const favActive = favs.has(i._id);
      const img = escapeHtml(i.img);
      const cat = escapeHtml(i.cat);
      const title = escapeHtml(i.t);

      // subt√≠tulo seg√∫n tipo
      let sub = '';
      if (isSportsItem(i)) {
        const comp = i.meta?.competition ? `${i.meta.competition}` : '';
        const j = i.meta?.jornada ? `J${i.meta.jornada}` : '';
        const venue = i.meta?.venue ? `${i.meta.venue}` : '';
        const h = i.meta?.hora_original || '';
        const tz = i.meta?.timezone || '';
        const canal = i.meta?.canal || '';
        const parts = [comp, j, venue, (h && tz) ? `${h} ${tz}` : h, canal].filter(Boolean);
        sub = parts.join(' ‚Ä¢ ');
      } else {
        const sec = i.meta?.section || '';
        const se = i.meta?.se || '';
        const q = i.meta?.quality || '';
        const flags = (i.meta?.flags || []).slice(0,2).join(' ');
        const parts = [sec, se, flags, q].filter(Boolean);
        sub = parts.join(' ‚Ä¢ ');
      }

      return `
        <div class="card">
          <div class="logo-container">
            <img src="${img}" class="logo-img" loading="lazy" onerror="this.src='logo.png'">
          </div>
          <div class="info">
            <div class="cat-tag">${cat}</div>
            <div class="title">${title}</div>
            <div class="subtitle">${escapeHtml(sub || ' ')}</div>
          </div>
          <div class="actions">
            <button class="btn-fav ${favActive ? 'active' : ''}" onclick="toggleFav(${JSON.stringify(i._id)})">‚òÖ</button>
            <button class="btn-play" onclick="openInfo(${JSON.stringify(i)})">INFO</button>
          </div>
        </div>`;
    }).join('');
  }

  function toggleFav(id) {
    const favs = new Set(safeGetFavs());
    if (favs.has(id)) favs.delete(id);
    else favs.add(id);
    safeSetFavs(Array.from(favs));
    tg?.HapticFeedback?.impactOccurred?.('light');
    render();
  }

  function filterData(cat, el) {
    document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
    if (el) el.classList.add('active');
    currentFilter = cat;
    tg?.HapticFeedback?.impactOccurred?.('light');
    render();
  }

  // Modal INFO
  function openInfo(item) {
    const modal = document.getElementById('modal');
    document.getElementById('m-cat').textContent = item.cat || '';
    document.getElementById('m-title').textContent = item.t || '';
    const meta = item.meta || {};

    let lines = [];

    if (isSportsItem(item)) {
      if (meta.competition) lines.push(`<span class="kv">Competencia:</span> ${escapeHtml(meta.competition)}`);
      if (meta.jornada) lines.push(`<span class="kv">Jornada:</span> ${escapeHtml(meta.jornada)}`);
      if (meta.venue) lines.push(`<span class="kv">Sede:</span> ${escapeHtml(meta.venue)}`);
      if (meta.ronda) lines.push(`<span class="kv">Ronda:</span> ${escapeHtml(meta.ronda)}`);
      const time = [meta.hora_original, meta.timezone].filter(Boolean).join(' ');
      if (time) lines.push(`<span class="kv">Horario:</span> ${escapeHtml(time)}`);
      if (meta.canal) lines.push(`<span class="kv">Canal:</span> ${escapeHtml(meta.canal)}`);
      if (meta.date_label) lines.push(`<span class="kv">Secci√≥n:</span> ${escapeHtml(meta.date_label)}`);
    } else {
      if (meta.section) lines.push(`<span class="kv">Secci√≥n:</span> ${escapeHtml(meta.section)}`);
      if (meta.se) lines.push(`<span class="kv">Episodio:</span> ${escapeHtml(meta.se)}`);
      if ((meta.flags || []).length) lines.push(`<span class="kv">Audio/Sub:</span> ${escapeHtml(meta.flags.join(' ‚Ä¢ '))}`);
      if (meta.quality) lines.push(`<span class="kv">Calidad:</span> ${escapeHtml(meta.quality)}`);
      if (meta.date_label) lines.push(`<span class="kv">Fecha:</span> ${escapeHtml(meta.date_label)}`);
      if (meta.title_clean) lines.push(`<span class="kv">T√≠tulo limpio:</span> ${escapeHtml(meta.title_clean)}`);
    }

    document.getElementById('m-meta').innerHTML = lines.length ? lines.join('<br>') : 'Sin detalles adicionales.';
    modal.style.display = 'flex';
    tg?.HapticFeedback?.impactOccurred?.('light');
  }

  function closeInfo() {
    document.getElementById('modal').style.display = 'none';
  }

  document.getElementById('m-close').addEventListener('click', closeInfo);
  document.getElementById('modal').addEventListener('click', (e) => {
    if (e.target.id === 'modal') closeInfo();
  });

  document.getElementById('search').addEventListener('input', (e) => {
    currentSearch = e.target.value;
    render();
  });

  document.getElementById('status-close').addEventListener('click', () => clearStatus());

  document.getElementById('btn-request-vip').addEventListener('click', () => {
    try {
      tg?.sendData?.(JSON.stringify({ action: "vip_request" }));
      showStatus("‚úÖ Solicitud enviada al administrador.", 1, true);
    } catch (e) {
      showStatus("‚ö†Ô∏è No se pudo enviar solicitud. Abre el bot y usa 'Solicitar acceso'.", 2, true);
    }
  });

  // Auto refresh cada 15 min
  setInterval(() => {
    init();
  }, 15 * 60 * 1000);

  tg?.ready?.();
  tg?.expand?.();
  init();

  // exponer funciones globales para onclick inline
  window.toggleFav = toggleFav;
  window.filterData = filterData;
  window.openInfo = openInfo;
</script>
</body>
</html>
